<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NGSPL Smart Classroom</title>
  <link rel="stylesheet" href="style.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Moul&display=swap" rel="stylesheet">
  <style>
    /* Header Design (រចនា Header ថ្មី) */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 50px;
      background: linear-gradient(90deg, #00c6ff, #0072ff); /* ពណ៌ខៀវ */
      /* backdrop-filter: blur(20px); */ /* បិទដើម្បីឱ្យលឿន ព្រោះពណ៌ Background ស្រអាប់បាំងជិតហើយ */
      box-shadow: 0 10px 30px rgba(0,0,0,0.05); /* ស្រមោលទន់ទំនើប */
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid rgba(255, 255, 255, 0.5);
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
      font-family: 'Moul', cursive;
      font-size: 1.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3); /* ស្រមោលអក្សរ */
    }
    .logo span {
      background: linear-gradient(to right, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8f00ff, #ff0000);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      background-size: 200% auto;
      animation: rainbow 3s linear infinite;
      display: inline-block;
    }
    .logo:hover span {
      animation: rainbow 3s linear infinite, bounce 1s ease infinite;
    }
    @keyframes rainbow {
      to { background-position: 200% center; }
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
      40% {transform: translateY(-15px);}
      60% {transform: translateY(-7px);}
    }
    .logo img { 
      height: 80px; 
    }

    /* Modal Styles */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      background-color: rgba(0, 0, 0, 0.6); 
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s;
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      position: relative;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      animation: slideIn 0.3s;
      overflow: hidden;
      font-family: 'Khmer OS Battambang', sans-serif;
    }
    .modal-header {
      background-color: #f1f1f1;
      padding: 15px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 24px;
      color: #333;
    }
    .close-btn {
      font-size: 24px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      transition: all 0.4s ease;
      display: inline-block; /* កំណត់ឱ្យអាចវិលបាន */
    }
    .close-btn:hover { color: #e74c3c; transform: rotate(180deg) scale(1.2); }
    .modal-body { padding: 30px; color: #444; line-height: 1.8; font-size: 22px; }
    .modal-body ul { padding-left: 20px; margin: 0; }
    .modal-body li { margin-bottom: 8px; }
    
    /* Help Modal Specific Styles (Ensure White Background & Black Text) */
    #helpModal .modal-content { background-color: #ffffff; color: #000000; }
    #helpModal .modal-header { background-color: #ffffff; color: #000000; border-bottom: 1px solid #eee; }
    #helpModal .modal-header h2 { font-family: 'Moul', cursive; font-weight: bold; color: #003366; font-size: 24px; }
    #helpModal .modal-body { color: #000000; }
    #helpModal .close-btn { color: #ff0000; }

    /* Dark Mode Overrides for Help Modal */
    body.dark-mode #helpModal .modal-content { background-color: #1e1e1e; color: #ffffff; }
    body.dark-mode #helpModal .modal-header { background-color: #1e1e1e; color: #ffffff; border-bottom: 1px solid #444; }
    body.dark-mode #helpModal .modal-header h2 { color: #ffffff; }
    body.dark-mode #helpModal .modal-body { color: #ffffff; }
    body.dark-mode #helpModal .close-btn { color: #ff6b6b; }
    body.dark-mode #helpModal .modal-body p { color: #ffffff !important; border-top-color: #444 !important; }

    /* Dark Mode Overrides for History Modal */
    body.dark-mode #historyModal .modal-content { background-color: #1e1e1e; color: #ffffff; }
    body.dark-mode #historyModal .modal-header { background-color: #1e1e1e; color: #ffffff; border-bottom: 1px solid #444; }
    body.dark-mode #historyModal .modal-header h2 { color: #ffffff; }
    body.dark-mode #historyModal .modal-body { color: #ffffff; }
    body.dark-mode #historyModal .close-btn { color: #ff6b6b; }
    body.dark-mode #historyList li { border-bottom: 1px solid #444 !important; }
    body.dark-mode #historyList li span { color: #ddd !important; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Page Load Smooth Transition (Effect ពេល Refresh) */
    body {
      animation: pageFadeIn 0.8s cubic-bezier(0.22, 1, 0.36, 1);
    }
    @keyframes pageFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Timeout Modal Design (ផ្ទាំងដល់ម៉ោង) */
    #timeoutModal .modal-content {
      background: linear-gradient(135deg, #ff416c, #ff4b2b);
      color: white;
      text-align: center;
      border-radius: 20px;
      width: 90%;
      max-width: 420px;
      border: 4px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      margin: 15vh auto; /* Center vertically */
    }
    #timeoutModal h2 {
      font-family: 'Khmer OS Muol Light';
      font-size: 2.5rem;
      margin: 15px 0;
      color: white !important;
      text-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    .timeout-icon {
      font-size: 6rem;
      display: block;
      margin: 0 auto;
      animation: ring 1s infinite ease-in-out;
    }
    @keyframes ring {
      0% { transform: rotate(0); }
      10% { transform: rotate(15deg); }
      30% { transform: rotate(-15deg); }
      50% { transform: rotate(10deg); }
      70% { transform: rotate(-10deg); }
      90% { transform: rotate(5deg); }
      100% { transform: rotate(0); }
    }
    #timeoutModal button {
      background: white;
      color: #ff4b2b;
      border: none;
      padding: 10px 25px;
      font-size: 16px;
      border-radius: 50px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      font-family: 'Khmer OS Battambang';
      transition: transform 0.2s;
    }
    .hidden { display: none !important; }
    #timeoutModal button:hover {
      transform: scale(1.05);
    }

    /* Timer Warning Modal Design (ផ្ទាំងជូនដំណឹង) */
    #timerWarningModal .modal-content {
      background: linear-gradient(135deg, #f2994a, #f2c94c);
      color: white;
      text-align: center;
      border-radius: 20px;
      width: 90%;
      max-width: 420px;
      border: 4px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      margin: 15vh auto;
    }
    #timerWarningModal h2 {
      font-family: 'Khmer OS Muol Light';
      font-size: 2.2rem;
      margin: 15px 0;
      color: white !important;
      text-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    #timerWarningModal button {
      background: white;
      color: #f2994a; /* Text color matches the gradient */
      border: none;
      padding: 10px 25px;
      font-size: 16px;
      border-radius: 50px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      font-family: 'Khmer OS Battambang';
      transition: transform 0.2s;
    }
    #timerWarningModal button:hover {
      transform: scale(1.05);
    }

    /* Empty Input Modal Design (ផ្ទាំងជូនដំណឹងបញ្ចូលឈ្មោះ) */
    #emptyInputModal .modal-content {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      text-align: center;
      border-radius: 20px;
      width: 90%;
      max-width: 420px;
      border: 4px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      margin: 15vh auto;
    }
    #emptyInputModal h2 {
      font-family: 'Khmer OS Muol Light';
      font-size: 2.2rem;
      margin: 15px 0;
      color: white !important;
      text-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    #emptyInputModal button {
      background: white;
      color: #2980b9;
      border: none;
      padding: 10px 25px;
      font-size: 16px;
      border-radius: 50px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      font-family: 'Khmer OS Battambang';
      transition: transform 0.2s;
    }
    #emptyInputModal button:hover {
      transform: scale(1.05);
    }

    /* Save List Modal Design (ផ្ទាំងរក្សាទុកឈ្មោះថ្នាក់) */
    #saveListModal .modal-content {
      background: linear-gradient(135deg, #11998e, #38ef7d);
      color: white;
      text-align: center;
      border-radius: 20px;
      width: 90%;
      max-width: 420px;
      border: 4px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      margin: 15vh auto;
    }
    #saveListModal h2 {
      font-family: 'Khmer OS Muol Light';
      font-size: 2.2rem;
      margin: 15px 0;
      color: white !important;
      text-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    #saveListModal input {
      width: 80%; padding: 12px; border-radius: 25px; border: none;
      font-family: 'Khmer OS Battambang'; font-size: 1.1rem; text-align: center;
      margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); outline: none;
    }

    /* Delete Confirm Modal Design (ផ្ទាំងបញ្ជាក់ការលុប) */
    #deleteConfirmModal .modal-content {
      background: linear-gradient(135deg, #ff416c, #ff4b2b);
      color: white;
      text-align: center;
      border-radius: 20px;
      width: 90%;
      max-width: 420px;
      border: 4px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      margin: 15vh auto;
    }
    #deleteConfirmModal h2 {
      font-family: 'Khmer OS Muol Light';
      font-size: 2.2rem;
      margin: 15px 0;
      color: white !important;
      text-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    
    /* No Names Modal Design (ផ្ទាំងគ្មានឈ្មោះសម្រាប់ចម្លង) */
    #noNamesToCopyModal .modal-content {
      background: linear-gradient(135deg, #8e44ad, #9b59b6); /* Purple Gradient */
      color: white;
      text-align: center;
      border-radius: 20px;
      width: 90%;
      max-width: 420px;
      border: 4px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      margin: 15vh auto;
    }
    #noNamesToCopyModal h2 {
      font-family: 'Khmer OS Muol Light';
      font-size: 2.2rem;
      margin: 15px 0;
      color: white !important;
      text-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    
    /* Save Empty Modal Design (ផ្ទាំងបញ្ជីទទេពេលរក្សាទុក) */
    #saveEmptyModal .modal-content {
      background: linear-gradient(135deg, #ff9966, #ff5e62); /* Orange-Red Gradient */
      color: white;
      text-align: center;
      border-radius: 20px;
      width: 90%;
      max-width: 420px;
      border: 4px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      margin: 15vh auto;
    }
    #saveEmptyModal h2 {
      font-family: 'Khmer OS Muol Light';
      font-size: 2.2rem;
      margin: 15px 0;
      color: white !important;
      text-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    /* Success Modal Design (ផ្ទាំងជោគជ័យ) */
    #successModal .modal-content {
      background: linear-gradient(135deg, #11998e, #38ef7d); /* Green Gradient */
      color: white;
      text-align: center;
      border-radius: 20px;
      width: 90%;
      max-width: 420px;
      border: 4px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      margin: 15vh auto;
    }
    #successModal h2 {
      font-family: 'Khmer OS Muol Light';
      font-size: 2.2rem;
      margin: 15px 0;
      color: white !important;
      text-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    /* Font size for Import/Clear buttons to match Table Header (ល.រ.) */
    .controls .buttons button, #saveImage, #savePdf, #saveImage2, #savePdf2 {
      font-size: 14px;
      padding: 5px 12px;
    }

    /* Container for Fishing Buttons */
    .export-history-buttons {
      display: flex;
      gap: 5px;
      margin-top: 5px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* Container for Save Actions (Group Section) */
    .save-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* Compact buttons for Saved Lists Manager */
    .saved-lists-manager .buttons button {
      padding: 5px 12px !important;
      font-size: 14px !important;
    }

    /* 3D Button Design (All Buttons) */
    .buttons button, 
    #spinButton, 
    .preset-btn, 
    .save-actions button, 
    .panel-buttons button,
    #timeoutModal button,
    #timerWarningModal button, #deleteConfirmModal button, #successModal button,
    #emptyInputModal button, #saveListModal button, #noNamesToCopyModal button, #saveEmptyModal button,
    #distributeGroups, #distributeGroups2 {
      border: none;
      font-family: 'Khmer OS Battambang';
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.1s ease;
      box-shadow: 0 6px 0 rgba(0,0,0,0.2) !important;
      font-weight: bold;
      transform: translateY(0);
      font-size: 14px;
      white-space: nowrap;
      margin: 5px;
      padding: 6px 12px;
    }

    /* Import & Clear Buttons (Fresh Colors) */
    #importNames, #importGroupNames, #importGroupNames2, #importFishingNames {
      background: linear-gradient(135deg, #00c6ff, #0072ff); /* Vibrant Blue */
      color: #000;
    }
    #clearNames, #clearGroupNames, #clearGroupNames2, #clearFishingNames {
      background: linear-gradient(135deg, #ff416c, #ff4b2b); /* Vibrant Red */
      color: #000;
    }
    
    /* Distribute Groups Button (Purple) - Match Save List Size */
    #distributeGroups, #distributeGroups2 {
      background: linear-gradient(135deg, #834d9b, #d04ed6);
      color: white;
      padding: 5px 12px;
      font-size: 14px;
    }

    /* Override Saved List Load Button to pop against blue background */
    [id^="savedLists"][id$="BtnLoad"] {
      background: linear-gradient(135deg, #00c6ff, #0072ff) !important;
    }

    /* Timer Preset Buttons (Pink) */
    .preset-btn {
      background: linear-gradient(135deg, #ec008c, #fc6767); /* Pink Gradient */
      color: #000;
    }

    /* Animation for Preset Buttons on Hover (ចលនាលោតពេលដាក់ Mouse ពីលើ) */
    @keyframes jumpBtn {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    .preset-btn:hover {
      animation: jumpBtn 0.6s ease infinite;
    }

    /* History Button Design (ប៊ូតុងប្រវត្តិ) */
    #historyNames, #historyFishing, #historyGroups, #historyGroups2, #historyTimer {
      background: linear-gradient(135deg, #DA22FF 0%, #9733EE 100%); /* Fresh Purple Gradient */
      color: #000;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px; /* Rectangular */
      font-family: 'Khmer OS Battambang';
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(142, 84, 233, 0.4);
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      gap: 8px;
      flex: 1; /* Same size */
      font-size: 14px;
    }
    #historyNames:hover, #historyFishing:hover, #historyGroups:hover, #historyGroups2:hover, #historyTimer:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(142, 84, 233, 0.6);
      filter: brightness(1.3);
    }
    #historyNames:active, #historyFishing:active, #historyGroups:active, #historyGroups2:active, #historyTimer:active { transform: translateY(1px); box-shadow: 0 2px 5px rgba(142, 84, 233, 0.3); }

    /* Export Button Design (ប៊ូតុង Excel) */
    #exportNames, #exportFishingNames, #exportGroupNames, #exportGroupNames2 {
      background: linear-gradient(135deg, #11998e, #38ef7d); /* Green Gradient */
      color: #000;
      border: none;
      border-radius: 10px; /* Rectangular */
      font-family: 'Khmer OS Battambang';
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(17, 153, 142, 0.3);
      transition: all 0.3s ease;
      flex: 1; /* Same size */
    }
    #exportNames:hover, #exportFishingNames:hover, #exportGroupNames:hover, #exportGroupNames2:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(17, 153, 142, 0.5); filter: brightness(1.3); }
    #exportNames:active, #exportFishingNames:active, #exportGroupNames:active, #exportGroupNames2:active { transform: translateY(1px); box-shadow: 0 2px 5px rgba(17, 153, 142, 0.3); }

    /* Hide Names Button Design */
    .hide-names-btn {
      background: linear-gradient(135deg, #FF512F, #DD2476); /* Pink-Red Gradient */
      color: #000;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      font-family: 'Khmer OS Battambang';
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(221, 36, 118, 0.4);
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      gap: 8px;
      flex: 1; /* Same size */
      user-select: none;
      font-size: 14px;
    }
    .hide-names-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(221, 36, 118, 0.6);
      filter: brightness(1.3);
    }
    .hide-names-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(221, 36, 118, 0.3);
    }
    .hide-names-btn input {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #fff;
    }

    /* Group Header & Copy Button Design */
    .group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
      padding-bottom: 2px;
      border-bottom: 2px solid #f0f0f0;
    }
    .group-header h4 {
      margin: 0;
      color: #2c3e50;
      font-family: 'Khmer OS Muol Light';
      font-size: 1.1rem;
    }
    .copy-btn {
      background: linear-gradient(135deg, #00b09b, #96c93d); /* Fresh Green Gradient */
      color: #000;
      border: none;
      border-radius: 20px;
      padding: 5px 10px;
      font-family: 'Khmer OS Battambang';
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 176, 155, 0.3);
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .copy-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 176, 155, 0.5); filter: brightness(1.3); }
    .copy-btn:active { transform: translateY(1px); box-shadow: 0 2px 5px rgba(0, 176, 155, 0.3); }

    /* Drag and Drop Styles */
    .group ul {
      min-height: 60px; /* Ensure empty groups are droppable */
      transition: all 0.2s ease;
      border: 2px dashed transparent;
      border-radius: 10px;
      padding: 2px;
      margin: 0;
    }
    .group ul.drag-over {
      background: rgba(0, 176, 155, 0.15);
      border-color: #00b09b;
      transform: scale(1.02);
    }
    .group li {
      cursor: grab;
      margin: 0;
      padding: 0;
      line-height: 1.1;
      font-size: 15px;
    }
    .group li:active { cursor: grabbing; }

    /* Fullscreen Button Design (Unified & Beautiful) */
    #spinFullscreenBtn, #fishingFullscreenBtn, #timerFullscreenBtn, #fullscreenBtn, #fullscreenBtn2 {
      background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); /* Vibrant Blue Gradient */
      color: #000;
      border: none;
      border-radius: 15px; /* Rectangular */
      font-family: 'Khmer OS Battambang';
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 6px 0 rgba(0,0,0,0.2) !important;
      transition: all 0.1s ease;
      padding: 6px 12px;
      flex: 0 0 auto;
      font-size: 14px;
    }

    /* Specific styles for Timer Buttons to maintain size */
    #timerSection .buttons button {
      color: #000;
      font-size: 14px;
      padding: 6px 12px;
      min-width: 80px;
      white-space: nowrap;
    }
    
    /* ⭐ Responsive Timer Buttons */
    @media (max-width: 600px) {
      #timerSection .buttons button {
        min-width: auto; /* Allow smaller width on mobile */
        flex: 1; /* Distribute space evenly */
        font-size: 14px;
        padding: 10px;
      }
    }
    
    /* Timer Input Placeholders Black (ធ្វើឱ្យអក្សរ Placeholder ពណ៌ខ្មៅ) */
    #timerHourInput::placeholder,
    #timerMinuteInput::placeholder,
    #timerSecondInput::placeholder {
      color: #000000;
      opacity: 0.5;
    }

    /* Dark Mode Placeholders for Timer */
    body.dark-mode #timerHourInput::placeholder,
    body.dark-mode #timerMinuteInput::placeholder,
    body.dark-mode #timerSecondInput::placeholder {
      color: #ffffff;
      opacity: 0.7;
    }
    
    /* Dark Mode Button Text Color Override */
    body.dark-mode nav button,
    body.dark-mode .dropbtn,
    body.dark-mode .buttons button,
    body.dark-mode .preset-btn,
    body.dark-mode .save-actions button,
    body.dark-mode .panel-buttons button,
    body.dark-mode .export-history-buttons button,
    body.dark-mode .hide-names-btn,
    body.dark-mode #spinFullscreenBtn,
    body.dark-mode #fishingFullscreenBtn,
    body.dark-mode #timerFullscreenBtn,
    body.dark-mode #fullscreenBtn,
    body.dark-mode #fullscreenBtn2 {
      color: #ffffff !important;
    }

    /* Dark Mode Input Text Color Override */
    body.dark-mode input[type="text"],
    body.dark-mode input[type="number"],
    body.dark-mode textarea,
    body.dark-mode select,
    body.dark-mode #saveListNameInput,
    body.dark-mode .group h4 input {
      color: #ffffff !important;
      background: #2d2d2d !important;
      border-color: #555 !important;
    }

    /* Hover & Active States for 3D Buttons */
    .buttons button:hover, #spinButton:hover, .preset-btn:hover, .save-actions button:hover, .panel-buttons button:hover, #timeoutModal button:hover, #timerWarningModal button:hover, #emptyInputModal button:hover, #saveListModal button:hover, #deleteConfirmModal button:hover, #noNamesToCopyModal button:hover, #saveEmptyModal button:hover, #successModal button:hover, #spinFullscreenBtn:hover, #fishingFullscreenBtn:hover, #timerFullscreenBtn:hover, #fullscreenBtn:hover, #fullscreenBtn2:hover, #distributeGroups:hover, #distributeGroups2:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 0 rgba(0,0,0,0.2) !important;
      filter: brightness(1.25);
    }

    .buttons button:active, #spinButton:active, .preset-btn:active, .save-actions button:active, .panel-buttons button:active, #timeoutModal button:active, #timerWarningModal button:active, #emptyInputModal button:active, #saveListModal button:active, #deleteConfirmModal button:active, #noNamesToCopyModal button:active, #saveEmptyModal button:active, #successModal button:active, #spinFullscreenBtn:active, #fishingFullscreenBtn:active, #timerFullscreenBtn:active, #fullscreenBtn:active, #fullscreenBtn2:active, #distributeGroups:active, #distributeGroups2:active {
      transform: translateY(6px) !important;
      box-shadow: 0 0 0 rgba(0,0,0,0.2) !important;
    }
    
    #startTimer { background: linear-gradient(45deg, #11998e, #38ef7d); }
    #stopTimer { background: linear-gradient(45deg, #cb2d3e, #ef473a); }
    #resetTimer { background: linear-gradient(45deg, #DA22FF, #9733EE); width: auto; padding: 6px 15px; flex-shrink: 0; }

    /* Beautiful Buttons for Empty List Modals */
    #noNamesToCopyModal button, #saveEmptyModal button, #successModal button {
      background: white !important;
      padding: 10px 30px !important;
      font-size: 16px !important;
      border-radius: 50px !important;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2) !important;
      border: 4px solid rgba(255,255,255,0.5) !important;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
      margin-top: 15px;
    }
    #noNamesToCopyModal button { color: #8e44ad !important; }
    #saveEmptyModal button { color: #ff5e62 !important; }
    #successModal button { color: #11998e !important; }

    #noNamesToCopyModal button:hover, #saveEmptyModal button:hover, #successModal button:hover {
      transform: translateY(-5px) scale(1.05) !important;
      box-shadow: 0 15px 30px rgba(0,0,0,0.3) !important;
    }
    #noNamesToCopyModal button:active, #saveEmptyModal button:active, #successModal button:active {
      transform: translateY(2px) scale(0.95) !important;
      box-shadow: 0 5px 10px rgba(0,0,0,0.2) !important;
    }

    /* Spin Button Specific Style (Circular & Centered) */
    #spinButton {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 60px;
      height: 60px;
      margin-left: -30px;
      margin-top: -30px;
      border-radius: 50% !important;
      padding: 0 !important;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      background: radial-gradient(circle at 30% 30%, #ffffff, #e6e6e6);
      color: #d32f2f;
      border: 5px solid rgba(255, 255, 255, 0.9) !important;
      box-shadow: 0 0 0 5px rgba(211, 47, 47, 0.15), 0 10px 25px rgba(0,0,0,0.3), inset 0 -5px 10px rgba(0,0,0,0.1) !important;
      font-family: 'Khmer OS Muol Light', cursive;
      font-size: 16px;
      text-shadow: 0 1px 0 rgba(255,255,255,1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      animation: pulseGlow 2s infinite;
    }

    #spinButton:hover {
      transform: scale(1.15);
      box-shadow: 0 0 0 8px rgba(211, 47, 47, 0.25), 0 15px 35px rgba(211, 47, 47, 0.3), inset 0 -5px 10px rgba(0,0,0,0.1) !important;
      color: #b71c1c;
    }

    #spinButton:active {
      transform: scale(0.95);
      box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.3), 0 5px 10px rgba(0,0,0,0.2), inset 0 3px 5px rgba(0,0,0,0.2) !important;
    }

    @keyframes pulseGlow {
      0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7), 0 10px 25px rgba(0,0,0,0.3); }
      70% { box-shadow: 0 0 0 15px rgba(255, 255, 255, 0), 0 10px 25px rgba(0,0,0,0.3); }
      100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0), 0 10px 25px rgba(0,0,0,0.3); }
    }

    /* Rainbow Wheel Styles */
    .wheel-container {
      position: relative;
      z-index: 1;
    }
    .wheel-container::before {
      content: '';
      position: absolute;
      top: -0.1px; left: -0.1px; right: -0.1px; bottom: -0.1px;
      background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
      background-size: 400%;
      z-index: -1;
      border-radius: 50%;
      animation: rainbowGlow 20s linear infinite;
      box-shadow: 0 0 1px rgba(0,0,0,0.05);
    }
    @keyframes rainbowGlow {
      0% { background-position: 0 0; }
      50% { background-position: 400% 0; }
      100% { background-position: 0 0; }
    }
    #wheelCanvas {
      border-radius: 50%;
      animation: wheelHue 8s linear infinite;
      display: block;
    }
    @keyframes wheelHue {
      0% { filter: hue-rotate(0deg) saturate(1.5); }
      100% { filter: hue-rotate(360deg) saturate(1.5); }
    }

    /* Winner Zoom In Animation */
    @keyframes zoomInEffect {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      75% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    /* ✅ Responsive Grid Override for Mobile */
    @media (max-width: 480px) {
      .groups-grid {
        grid-template-columns: 1fr !important; /* Force single column on small screens */
      }
    }

    /* ⭐ បង្កើនទំហំផ្ទាំងលទ្ធផល (Result Panel) */
    .panel-content {
      width: 100% !important;
      height: 100% !important;
      min-width: auto !important;
      border-radius: 50% !important;
      padding: 0 !important;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      aspect-ratio: 1 / 1;
    }
    .panel-buttons button {
      font-size: 16px !important;
      padding: 10px 25px !important;
    }

    #panelResult {
      display: inline-block;
      font-family: 'Khmer OS Muol Light';
      font-size: 60px; /* បង្កើនទំហំអក្សរ */
      color: #e74c3c;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      animation: zoomInEffect 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* ✅ Responsive Overrides for Result Panel on Mobile */
    @media (max-width: 768px) {
      .panel-content {
        width: 100% !important;
        height: 100% !important;
        border-radius: 50% !important;
        padding: 0 !important;
      }
      .panel-buttons {
        flex-wrap: wrap;
      }
      .panel-buttons button {
        width: 100%; /* Stack buttons for easier tapping */
        margin: 5px 0;
      }
      #panelResult {
        font-size: 12vw; /* Scale down text */
      }
    }

    /* Shake Animation for Timer */
    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    .shake-animation {
      animation: shake 0.5s infinite;
    }

    /* Pointer Design (Kbach Khmer Style) */
    .pointer {
      position: absolute;
      top: 50%; 
      right: -25px;
      transform: translateY(-50%);
      width: 50px;
      height: 40px;
      background: radial-gradient(circle at 30% 30%, #ffffff, #ff0000 50%, #b30000 100%);
      clip-path: polygon(
        100% 15%, 85% 15%, 85% 35%, 65% 35%, 65% 20%, 
        0% 50%, 
        65% 80%, 65% 65%, 85% 65%, 85% 85%, 100% 85%
      );
      z-index: 20;
      transform-origin: right center;
      animation: pointerGlow 1.5s ease-in-out infinite alternate;
    }

    @keyframes pointerGlow {
      from { filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.6)) drop-shadow(2px 4px 5px rgba(0,0,0,0.4)); }
      to { filter: drop-shadow(0 0 25px rgba(255, 0, 0, 1)) drop-shadow(2px 4px 5px rgba(0,0,0,0.4)); }
    }

    /* Fishing Game Styles */
    #fishingSection .fishing-container {
      position: relative;
      width: calc(100% - 4cm);
      height: 55vh;
      margin: 0 auto;
      /* ដាក់រូបភាពផ្ទៃខាងក្រោយ (ដាក់រូបឈ្មោះ fishing_bg.jpg ក្នុង Folder ជាមួយគ្នា) */
      background: url('fishing_bg.jpg') center/cover no-repeat, linear-gradient(270deg, #001e3c, #004e92, #001e3c);
      background-size: 400% 400%;
      animation: waterMove 15s ease infinite;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.2);
      border: 4px solid #fff;
    }
    /* Bubbles Animation Layer (ពពុះទឹកហោះឡើងលើ) */
    .bubbles-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    .bubble {
      position: absolute;
      bottom: -40px;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.1));
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      box-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
      animation: bubbleRise 8s infinite ease-in;
      opacity: 0;
    }
    @keyframes bubbleRise {
      0% { bottom: -40px; transform: translateX(0) scale(0.8); opacity: 0; }
      10% { opacity: 0.6; }
      50% { transform: translateX(20px) scale(1); }
      100% { bottom: 120%; transform: translateX(-20px) scale(1.2); opacity: 0; }
    }
    .bubble:nth-child(1) { left: 10%; width: 15px; height: 15px; animation-duration: 7s; animation-delay: 0s; }
    .bubble:nth-child(2) { left: 25%; width: 25px; height: 25px; animation-duration: 10s; animation-delay: 2s; }
    .bubble:nth-child(3) { left: 40%; width: 10px; height: 10px; animation-duration: 5s; animation-delay: 4s; }
    .bubble:nth-child(4) { left: 55%; width: 30px; height: 30px; animation-duration: 12s; animation-delay: 1s; }
    .bubble:nth-child(5) { left: 70%; width: 20px; height: 20px; animation-duration: 8s; animation-delay: 3s; }
    .bubble:nth-child(6) { left: 85%; width: 12px; height: 12px; animation-duration: 6s; animation-delay: 5s; }
    .bubble:nth-child(7) { left: 15%; width: 18px; height: 18px; animation-duration: 9s; animation-delay: 1.5s; }
    .bubble:nth-child(8) { left: 60%; width: 22px; height: 22px; animation-duration: 11s; animation-delay: 0.5s; }

    @keyframes waterMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    #fishingCanvas {
      width: 100%;
      height: 100%;
      display: block;
      position: relative; /* ដាក់ឱ្យត្រីនៅពីមុខថ្ម */
      z-index: 10;
    }
    #startFishingBtn {
      display: block;
      margin: 0 auto 15px auto;
      z-index: 10;
      background: linear-gradient(135deg, #ff6b6b, #ee5253);
      color: white;
      font-family: 'Khmer OS Muol Light', cursive;
      font-size: 14px;
      padding: 8px 25px;
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #startFishingBtn:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 15px 25px rgba(0,0,0,0.4);
      background: linear-gradient(135deg, #ff4757, #ff6b6b);
      filter: brightness(1.2);
    }
    #startFishingBtn:active {
      transform: translateY(2px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }
    #fishingResultOverlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex; justify-content: center; align-items: center;
      z-index: 20;
      flex-direction: column;
    }
    .fishing-res-btn {
      padding: 8px 20px;
      font-size: 16px;
      font-family: 'Khmer OS Battambang';
      border-radius: 50px;
      border: 2px solid rgba(255,255,255,0.5);
      cursor: pointer;
      color: white;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .fishing-res-btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 15px 30px rgba(0,0,0,0.4); filter: brightness(1.2); }
    .fishing-res-btn:active { transform: translateY(2px); box-shadow: 0 5px 10px rgba(0,0,0,0.2); }

    #addFishingResultBtn { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    #removeFishingResultBtn { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    #closeFishingResultBtn { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }

    #fishingWinner {
      color: #ffffff;
      font-family: 'Khmer OS Muol Light';
      font-size: 60px;
      text-align: center;
      animation: zoomInEffect 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), neonGlow 1.5s ease-in-out infinite alternate 0.6s;
    }
    @keyframes neonGlow {
      from { text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; transform: scale(1); }
      to { text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0 0 20px #FFD700; transform: scale(1.1); }
    }

    /* Logo Clickable Style */
    .logo {
      cursor: pointer;
      transition: transform 0.2s;
    }
    .logo:active { transform: scale(0.95); }

    /* ================= COLORFUL NAV MENUS (មីនុយចម្រុះពណ៌) ================= */
    nav {
      font-family: 'Khmer OS Muol Light', cursive;
      display: flex;
      flex-wrap: nowrap; /* មិនឱ្យធ្លាក់បន្ទាត់ */
      align-items: center;
      margin-left: 1.5cm;
    }
    nav button {
      border: 2px solid #000;
      padding: 6px 12px;
      margin: 2px;
      border-radius: 30px;
      font-family: 'Khmer OS Muol Light', cursive;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.5px;
      color: #000;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      text-shadow: none;
      white-space: nowrap;
    }
    
    /* Shine Effect (ភ្លើងរត់) */
    nav button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.9), transparent);
      transition: all 0.6s;
    }
    nav button:hover::before {
      left: 100%;
    }

    /* 2. Spin Tab (Blue) */
    #spinTab { background: linear-gradient(135deg, #36D1DC, #5B86E5); color: #000; font-weight: bold; box-shadow: 0 4px 15px rgba(91, 134, 229, 0.3); }
    
    /* 3. Group Tab (Purple) */
    #groupTab { background: linear-gradient(135deg, #834d9b, #d04ed6); color: #000; font-weight: bold; box-shadow: 0 4px 15px rgba(208, 78, 214, 0.3); }
    #groupTab2 { background: linear-gradient(135deg, #834d9b, #d04ed6); color: #000; font-weight: bold; }
    
    /* 4. Timer Tab (Red/Orange) */
    #timerTab { background: linear-gradient(135deg, #FF416C, #FF4B2B); color: #000; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 75, 43, 0.3); }
    
    /* 5. Fishing Tab (Teal) */
    #fishingTab { background: linear-gradient(135deg, #11998e, #38ef7d); color: #000; font-weight: bold; box-shadow: 0 4px 15px rgba(56, 239, 125, 0.3); }

    /* Hover & Active Effects for All */
    nav button:hover, nav button.active {
      transform: translateY(-3px) scale(1.05);
      filter: brightness(1.4);
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.6), 0 8px 20px rgba(0,0,0,0.4);
      z-index: 10;
    }

    /* Tab Switch Animation (ចលនាពេលចុចប្តូរមីនុយ) */
    @keyframes tabPulse {
      0% { transform: scale(0.95); }
      50% { transform: scale(1.1); }
      100% { transform: translateY(-3px) scale(1.05); }
    }

    nav button.active {
      border: 2px solid #000;
      animation: tabPulse 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* Dropdown Menu Styles */
    .dropdown {
      display: inline-block;
      position: relative;
      margin: 2px;
    }
    .dropbtn {
      margin: 0 !important;
      background: linear-gradient(135deg, #36D1DC, #5B86E5); /* Blue */
      color: #000;
      font-weight: bold;
      min-width: 110px;
      font-family: 'Khmer OS Muol Light', cursive;
    }
    /* Group Dropdown Button Color (Purple) */
    #groupDropBtn {
      background: linear-gradient(135deg, #834d9b, #d04ed6);
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: rgba(255, 255, 255, 0.95);
      min-width: 100%;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      z-index: 1000;
      border-radius: 15px;
      top: 100%;
      left: 0;
      backdrop-filter: blur(10px);
      padding: 5px;
      animation: fadeIn 0.3s;
      font-family: 'Battambang', 'Khmer OS Battambang', sans-serif;
    }
    .dropdown:hover .dropdown-content { display: block; }
    .dropdown-content button { 
      margin: 5px 0 !important; 
      width: 100%; 
      font-family: 'Khmer OS Muol Light', cursive;
    }

    /* Icon Buttons Style (ប៊ូតុងតូចៗខាងស្តាំ) */
    .icon-btn {
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(179, 0, 0, 0.2); /* គែមពណ៌ក្រហមស្រាល */
      color: black;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      padding: 0;
      margin: 0 4px;
      position: relative;
      overflow: hidden;
      font-family: 'Battambang', 'Khmer OS Battambang', sans-serif;
    }
    
    /* Shine effect on hover */
    .icon-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.6), transparent);
      transition: all 0.5s;
    }
    .icon-btn:hover::before {
      left: 100%;
    }

    .icon-btn:hover {
      transform: translateY(-5px) scale(1.1);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      border-color: rgba(255, 255, 255, 0.8);
    }
    
    .icon-btn:active {
      transform: translateY(2px) scale(0.95);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Individual Colors on Hover */
    #langToggleBtn:hover { background: linear-gradient(135deg, #00c6ff, #0072ff); }
    #themeToggleBtn:hover { background: linear-gradient(135deg, #f093fb, #f5576c); }
    #toggleSoundBtn:hover { background: linear-gradient(135deg, #11998e, #38ef7d); }
    #helpBtn:hover { background: linear-gradient(135deg, #f2994a, #f2c94c); }

    #langToggleBtn {
      font-size: 12px;
      font-weight: 700;
      font-family: 'Battambang', 'Khmer OS Battambang', sans-serif;
    }

    /* ================= LANDING PAGE STYLES (ទំព័រដើម) ================= */
    #landingPage {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #2980B9, #6DD5FA); /* ពណ៌ផ្ទៃខាងក្រោយបែប Gradient (Blue-Sky) */
      z-index: 10000; /* នៅលើគេបង្អស់ */
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      transition: all 0.8s cubic-bezier(0.77, 0, 0.175, 1); /* Effect ពេលបិទ */
    }
    .landing-content {
      text-align: center;
      animation: slideUpFade 1s ease-out;
      position: relative;
      z-index: 10; /* នៅលើគ្រាប់ព្រិល */
    }
    .landing-logo {
      width: 7cm;
      margin-bottom: 30px;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
      animation: floatLogo 3s ease-in-out infinite; /* Logo អណ្តែត */
    }
    #landingPage h1 {
      font-family: 'Moul', cursive;
      font-size: 3.5rem;
      margin: 0 0 15px 0;
      background: linear-gradient(to right, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8f00ff, #ff0000);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      background-size: 200% auto;
      animation: rainbow 3s linear infinite;
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.8)) drop-shadow(0 4px 10px rgba(0,0,0,0.3));
      letter-spacing: 1px;
    }
    #landingPage h1:hover {
      animation: rainbow 3s linear infinite, bounce 1s ease infinite;
    }
    #landingPage p {
      font-family: 'Khmer OS Battambang';
      font-size: 1.8rem;
      margin-bottom: 50px;
      opacity: 0.9;
      font-weight: bold;
    }
    #enterBtn {
      padding: 10px 30px;
      font-size: 16px;
      font-family: 'Khmer OS Muol Light';
      color: #764ba2;
      background: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
    }
    #enterBtn:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      background: #f8f9fa;
      filter: brightness(1.1);
    }
    .landing-hidden {
      opacity: 0;
      transform: translateY(-100%); /* រុញឡើងលើពេលបិទ */
      pointer-events: none;
    }
    @keyframes floatLogo {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    @keyframes slideUpFade {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Snow Effect Styles */
    .snowflake {
      position: absolute;
      top: -10px;
      background: white;
      border-radius: 50%;
      pointer-events: none;
      z-index: 1;
      box-shadow: 0 0 5px rgba(255,255,255,0.8);
    }
    @keyframes fall {
      0% { transform: translateY(-10px) translateX(0); opacity: 1; }
      100% { transform: translateY(100vh) translateX(50px); opacity: 0; }
    }

    /* ================= CUSTOM TOOLTIP STYLES ================= */
    [data-tooltip] {
      position: relative;
    }
    /* Tooltip Body */
    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      top: auto;
      bottom: 135%; /* Show above the element */
      left: 50%;
      transform: translateX(-50%) translateY(15px) scale(0.8);
      
      /* Beautiful Dark Gradient & Glassy Look */
      background: linear-gradient(135deg, #1e3c72, #2a5298); /* Blue Gradient to match theme */
      color: #fff;
      padding: 10px 25px;
      border-radius: 50px; /* Pill Shape */
      font-family: 'Khmer OS Battambang', sans-serif;
      font-size: 0.95rem;
      font-weight: bold;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      pointer-events: none;
      z-index: 10000;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 0 2px rgba(255,255,255,0.2);
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    /* Tooltip Arrow */
    [data-tooltip]::before {
      content: '';
      position: absolute;
      top: auto;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%) translateY(15px) scale(0.8);
      border-width: 8px;
      border-style: solid;
      border-color: #1e3c72 transparent transparent transparent; /* Arrow pointing down */
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 10000;
    }
    /* Hover State */
    [data-tooltip]:hover::after,
    [data-tooltip]:hover::before {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0) scale(1);
    }

    /* Page Backgrounds (ពណ៌ផ្ទៃខាងក្រោយតាមទំព័រ) */
    body { 
      transition: background 0.8s ease; 
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      /* Removed min-width to allow responsiveness */
      width: 100%;
      /* ✅ Set default background to match Landing Page */
      background: linear-gradient(135deg, #2980B9, #6DD5FA);
    }
    /* សូមដាក់រូបភាពឈ្មោះ bg_spin.jpg, bg_group.jpg, bg_magic.jpg, bg_timer.jpg, bg_fishing.jpg ក្នុង Folder ជាមួយគ្នា */
    body.page-spin { background: linear-gradient(135deg, #2980B9, #6DD5FA); }
    body.page-group { background: linear-gradient(135deg, #2980B9, #6DD5FA); }
    body.page-magic { background: linear-gradient(135deg, #2980B9, #6DD5FA); }
    body.page-timer { background: linear-gradient(135deg, #2980B9, #6DD5FA); }
    body.page-fishing { background: linear-gradient(135deg, #2980B9, #6DD5FA); }
    
    @keyframes fishSwimBg { from { background-position: 0 0, center, center; } to { background-position: 400px -200px, center, center; } }
    
    /* Dark Mode Override */
    body.dark-mode { background: #2c3e50 !important; }

    /* Group Grid Layout (រៀបចំក្រុមជាក្រឡា) */
    .groups-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .group {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s;
      display: flex;
      flex-direction: column;
    }
    .group:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    /* ================= FULLSCREEN GROUP MODE ================= */
    :fullscreen header, 
    :fullscreen footer, 
    :fullscreen .responsive-col,
    :fullscreen .save-actions,
    :fullscreen .nav-icons, :fullscreen .nav-hamburger {
      display: none !important;
    }

    :fullscreen #groupSection .spin-content {
      width: 100vw;
      height: 100vh;
      padding: 0;
      margin: 0;
      max-width: none;
      justify-content: center;
      align-items: flex-start;
      overflow-y: auto;
      background: inherit; /* Keep background */
    }

    :fullscreen #groupsContainer {
      width: 100%;
      min-height: 100vh;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 40px;
      padding: 60px;
      box-sizing: border-box;
      align-content: center;
    }

    :fullscreen .group {
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      background: rgba(255,255,255,0.95);
    }
    :fullscreen .group h4 { font-size: 1.5rem; margin-bottom: 5px; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 5px; }
    :fullscreen .copy-btn { font-size: 12px; padding: 4px 8px; }
    :fullscreen .group ul { line-height: 2; text-align: left; margin-top: 0; }
    :fullscreen .group li { font-size: 22px; font-weight: bold; border-bottom: 1px dashed rgba(0,0,0,0.1); }
    :fullscreen .group li:last-child { border-bottom: none; }

    /* ================= GROUP CARD EDIT STYLES (រចនាការកែឈ្មោះក្រុម និងប្តូរពណ៌) ================= */
    /* Group Name Input (ពេលចុចពីរដងកែឈ្មោះ) */
    .group h4 input, .group-header input[type="text"] {
      width: 90%;
      font-family: 'Khmer OS Battambang', sans-serif;
      font-size: 0.95rem;
      text-align: center;
      border: 2px solid #00c6ff;
      border-radius: 50px; /* Pill Shape */
      padding: 5px 15px;
      outline: none;
      background: rgba(255, 255, 255, 0.95);
      color: #000;
      box-shadow: 0 0 15px rgba(0, 198, 255, 0.4);
      transition: all 0.3s ease;
      margin: 5px 0;
    }
    .group h4 input:focus, .group-header input[type="text"]:focus {
      transform: scale(1.05);
      border-color: #0072ff;
      box-shadow: 0 0 25px rgba(0, 114, 255, 0.5);
    }

    /* Color Picker in Group (ប៊ូតុងប្តូរពណ៌ក្រុម) */
    .group input[type="color"] {
      -webkit-appearance: none;
      appearance: none;
      border: 2px solid #fff;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      padding: 0;
      background: none;
      vertical-align: middle;
    }
    .group input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    .group input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }
    .group input[type="color"]:hover {
      transform: scale(1.3) rotate(15deg);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      z-index: 5;
    }

    /* ================= FULLSCREEN MAGIC BOOK ================= */
    :fullscreen #groupsContainer2 {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #2980B9, #6DD5FA);
      padding: 20px;
      box-sizing: border-box;
    }

    :fullscreen #groupsContainer2 .magic-book {
      width: 90vw;
      height: 80vh;
      max-width: 1800px;
      min-height: 0;
    }

    /* Magic Book Controls (Previous/Next) - Smaller Size */
    .book-controls button {
      font-size: 14px !important;
      padding: 5px 15px !important;
    }
    .book-controls span {
      font-size: 14px !important;
    }

    :fullscreen #groupsContainer2 .book-page {
      padding: 40px 60px;
    }

    /* ================= RESPONSIVE HEADER (ធ្វើឱ្យ Header ស្របគ្រប់អេក្រង់) ================= */
    @media (max-width: 1180px) {
      header {
        padding: 10px 20px;
      }
      nav {
        gap: 5px;
      }
      .nav-icons {
        margin-left: 5px !important;
        gap: 5px !important;
      }
    }

    /* Responsive Logo for Mobile (ធ្វើឱ្យ Logo តូចនៅពេលមើលលើទូរស័ព្ទ) */
    @media (max-width: 768px) {
      .logo img {
        height: 60px; /* បន្ថយមកត្រឹម 60px (ឬទំហំដែលអ្នកចង់បាន) */
      }
      .logo {
        font-size: 1.5rem; /* បន្ថយទំហំអក្សរ */
      }
    }

    :fullscreen #groupsContainer2 .group h4 { font-size: 18px; margin-bottom: 15px; }
    :fullscreen #groupsContainer2 .group ul li { font-size: 26px; font-weight: bold; padding: 15px 10px !important; line-height: 1.4; }
    :fullscreen #groupsContainer2 .book-controls { transform: scale(1); margin-top: 20px; }

    /* Additional Font Size Adjustments */
    textarea, input[type="text"], input[type="number"] {
      font-size: 18px !important;
      font-weight: bold;
    }
    table th, table td {
      font-size: 16px;
      font-weight: bold;
    }

  </style>
</head>
<body>

<!-- ================= LANDING PAGE HTML ================= -->
<div id="landingPage">
  <div class="landing-content">
    <img src="NGSPL Logo.png" alt="NGSPL Logo" class="landing-logo">
    <h1>NGSPL Smart Classroom</h1>
    <p>កម្មវិធីជំនួយការបង្រៀនដ៏ឆ្លាតវៃ និងទំនើប</p>
    <button id="enterBtn">ចាប់ផ្តើម</button>
  </div>
</div>

<header>
  <div class="logo" onclick="location.reload()" title="ចុចដើម្បី Refresh">
    <img src="NGSPL Logo.png" alt="NGSPL Logo">
    <span>NGSPL Smart Classroom</span>
  </div>
  <nav>
    <div class="dropdown">
      <button class="dropbtn" data-translate="randomCallTab">ហៅឈ្មោះ ▼</button>
      <div class="dropdown-content">
        <button id="spinTab" class="active" data-translate="spinTab">បង្វិលចៃដន្យ</button>
        <button id="fishingTab" data-translate="fishingTab">ស្ទូចត្រីចៃដន្យ</button>
      </div>
    </div>
    <div class="dropdown">
      <button id="groupDropBtn" class="dropbtn" data-translate="groupMenuTab">ចែកក្រុម ▼</button>
      <div class="dropdown-content">
        <button id="groupTab" data-translate="groupTab">ចែកក្រុមចៃដន្យ</button>
        <button id="groupTab2" data-translate="groupTab2">សៀវភៅចែកក្រុម</button>
      </div>
    </div>
    <button id="timerTab" data-translate="timerTab">កំណត់ពេលវេលា</button>
    
    <!-- Hamburger Menu -->
    <div class="dropdown nav-hamburger" style="margin-left: 15px;">
      <button class="icon-btn" style="width: 40px; height: 40px; font-size: 20px; border-radius: 50%; margin: 0; display: flex; justify-content: center; align-items: center;">☰</button>
      <div class="dropdown-content" style="left: auto; right: 0; min-width: 220px; border-radius: 15px;">
        <button id="langToggleBtn" style="text-align: left; padding-left: 20px;">🌐 ភាសា: KH</button>
        <button id="themeToggleBtn" style="text-align: left; padding-left: 20px;">🌙 Dark Mode</button>
        <div style="position: relative;">
            <button style="text-align: left; padding-left: 20px; width: 100%;">🎨 ពណ៌ Header</button>
            <input type="color" id="headerColorInput" value="#00c6ff" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
        </div>
        <button id="toggleSoundBtn" style="text-align: left; padding-left: 20px;">🔊 បិទ/បើកសំឡេង</button>
        <button id="helpBtn" style="text-align: left; padding-left: 20px;">❓ ជំនួយ</button>
      </div>
    </div>
  </nav>
</header>


<main>
  <!-- ================= Spin Section ================= -->
  <section id="spinSection">
    <div class="spin-content">
      <div style="width: 100%; max-width: calc(600px - 3cm);"> 
        <div class="controls" style="max-width: 100%;">
          <textarea id="nameInput" placeholder="សូមបញ្ចូលឈ្មោះត្រង់នេះ" data-translate-placeholder="nameInputPlaceholder" style="height: 80px;"></textarea>
          <div class="buttons">
            <button id="importNames" data-translate="importNames">បញ្ចូលបញ្ជីឈ្មោះ</button>
            <button id="copyNames" data-translate="copyNames" style="background: linear-gradient(135deg, #00b09b, #96c93d);">📋 ចម្លងឈ្មោះ</button>
            <button id="clearNames" data-translate="clearNames">លុបចោល</button>
          </div>
          <!-- Saved Lists Manager (ផ្នែកគ្រប់គ្រងបញ្ជីឈ្មោះតាមថ្នាក់) -->
          <div class="saved-lists-manager" style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
              <div class="custom-select-wrapper" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                <select id="savedListsDropdown">
                  <option value="">-- ជ្រើសរើសថ្នាក់ដែលបានរក្សាទុក --</option>
                </select>
              </div>
              <span id="totalNames" class="total-count" style="margin: 0;">សរុប: ០ នាក់</span>
            </div>
            <div class="buttons" style="justify-content: flex-start; margin: 0;">
               <button id="savedListsBtnSave" style="background: linear-gradient(135deg, #f2994a, #f2c94c); color: white; font-size: 14px;" data-translate="btnSaveList">រក្សាទុកបញ្ជី</button>
               <button id="savedListsBtnLoad" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; font-size: 14px;" data-translate="btnLoadList">ប្រើប្រាស់</button>
               <button id="savedListsBtnRename" style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white; font-size: 14px;" data-translate="btnRenameList">កែប្រែ</button>
               <button id="savedListsBtnDelete" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; font-size: 14px;" data-translate="btnDeleteList">លុប</button>
            </div>
          </div>
        </div>
        <div class="table-scroll-wrapper">
          <table id="namesTable">
            <thead>
              <tr>
                <th data-translate="thNo">ល.រ.</th>
                <th data-translate="thName">ឈ្មោះសិស្ស</th>
                <th data-translate="thAction">មុខងារ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button id="exportNames" data-translate="exportNames" style="display: none;">ទាញ Excel</button>
          <button id="historyNames" data-translate="historyLabel">ប្រវត្តិប្រតិបត្តិ</button>
          <button id="spinFullscreenBtn" data-translate="fullscreenBtn">ពេញអេក្រង់</button>
        </div>
      </div>

      <div class="wheel-wrapper">
        <div class="wheel-container" style="transform: none;">
          <div class="pointer"></div>
          <canvas id="wheelCanvas" width="400" height="400"></canvas>
          <button id="spinButton" data-translate="spinButton">បង្វិល</button>

          <div id="resultPanel" class="result-panel hidden">
            <div class="panel-content">
              <div class="panel-text">
                <span id="panelResult"></span>
              </div>
              <div class="panel-buttons">
                <button id="btnAdd" data-translate="btnAdd">បន្ថែម</button>
                <button id="btnRemove" data-translate="btnRemove">ដកចេញ</button>
                <button id="btnClose" data-translate="btnClose">បិទ</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- ================= Group Work Section ================= -->
  <section id="groupSection" class="hidden">
    <div class="spin-content" style="display: flex; gap: 20px; align-items: flex-start;">
      <!-- Left Column: Controls & Table -->
      <!-- ⭐ Removed min-width: 300px to allow full responsiveness -->
      <div style="width: 100%; max-width: calc(600px - 3cm); display: flex; flex-direction: column; gap: 20px;" class="responsive-col">
        <div class="controls" style="width: 100%; box-sizing: border-box; margin: 0;">
          <textarea id="groupNameInput" placeholder="សូមបញ្ចូលឈ្មោះត្រង់នេះ" data-translate-placeholder="groupNameInputPlaceholder" style="height: 80px;"></textarea>
          <div class="buttons">
            <button id="importGroupNames" data-translate="importGroupNames">បញ្ចូលបញ្ជីឈ្មោះ</button>
            <button id="copyGroupNames" data-translate="copyNames" style="background: linear-gradient(135deg, #00b09b, #96c93d);">📋 ចម្លងឈ្មោះ</button>
            <button id="clearGroupNames" data-translate="clearGroupNames">លុបចោល</button>
          </div>
          <!-- Saved Lists Manager (Group) -->
          <div class="saved-lists-manager" style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
              <div class="custom-select-wrapper" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                <select id="savedListsGroupDropdown">
                  <option value="">-- ជ្រើសរើសថ្នាក់ដែលបានរក្សាទុក --</option>
                </select>
              </div>
              <span id="totalGroupNames" class="total-count" style="margin: 0;">សរុប: ០ នាក់</span>
            </div>
            <div class="buttons" style="justify-content: flex-start; margin: 0;">
               <button id="savedListsGroupBtnSave" style="background: linear-gradient(135deg, #f2994a, #f2c94c); color: white; font-size: 14px;" data-translate="btnSaveList">រក្សាទុកបញ្ជី</button>
               <button id="savedListsGroupBtnLoad" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; font-size: 14px;" data-translate="btnLoadList">ប្រើប្រាស់</button>
               <button id="savedListsGroupBtnRename" style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white; font-size: 14px;" data-translate="btnRenameList">កែប្រែ</button>
               <button id="savedListsGroupBtnDelete" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; font-size: 14px;" data-translate="btnDeleteList">លុប</button>
            </div>
          </div>

          <div class="group-config" style="margin-top: 10px; padding: 5px;">
            <label for="groupCount" data-translate="groupCountLabel">ចំនួនក្រុម:</label>
            <input type="number" id="groupCount" min="1" placeholder="....." style="padding: 5px;"/>
            <button id="distributeGroups" data-translate="distributeGroups">ចែកក្រុមចៃដន្យ</button>
          </div>
        </div>

        <div>
          <div class="table-scroll-wrapper">
            <table id="groupNamesTable">
              <thead>
                <tr>
                  <th data-translate="thNo">ល.រ.</th>
                  <th data-translate="thName">ឈ្មោះសិស្ស</th>
                  <th data-translate="thAction">មុខងារ</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="buttons" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; justify-content: flex-start; align-items: center;">
            <button id="exportGroupNames" data-translate="exportGroupNames" style="display: none;">ទាញ Excel</button>
            <button id="saveImage" data-translate="saveImage">រក្សាទុករូបភាព</button>
            <button id="savePdf" data-translate="savePdf">រក្សាទុក PDF</button>
            <button id="fullscreenBtn" data-translate="fullscreenBtn">ពេញអេក្រង់</button>
          </div>
        </div>
      </div>

      <!-- Right Column: Groups -->
      <div id="groupWrapper" style="flex:1; min-width: 0; position: relative;">
        <div id="groupsContainer" class="groups-grid"></div>

        <!-- Floating Zoom Controls (Visible only in Fullscreen) -->
        <div class="fullscreen-zoom-controls">
           <button id="zoomInBtn">🔍+</button>
           <button id="zoomResetBtn">↺</button>
           <button id="zoomOutBtn">🔍-</button>
        </div>

      </div>
    </div>
  </section>

  <!-- ================= Group Work Section 2 ================= -->
  <section id="groupSection2" class="hidden">
    <div class="spin-content" style="display: flex; gap: 20px; align-items: flex-start;">
      <!-- Left Column: Controls & Table -->
      <div style="width: 100%; max-width: calc(600px - 3cm); display: flex; flex-direction: column; gap: 20px;" class="responsive-col">
        <div class="controls" style="width: 100%; box-sizing: border-box; margin: 0;">
          <textarea id="groupNameInput2" placeholder="សូមបញ្ចូលឈ្មោះត្រង់នេះ" data-translate-placeholder="groupNameInputPlaceholder" style="height: 80px;"></textarea>
          <div class="buttons">
            <button id="importGroupNames2" data-translate="importGroupNames">បញ្ចូលបញ្ជីឈ្មោះ</button>
            <button id="copyGroupNames2" data-translate="copyNames" style="background: linear-gradient(135deg, #00b09b, #96c93d);">📋 ចម្លងឈ្មោះ</button>
            <button id="clearGroupNames2" data-translate="clearGroupNames">លុបចោល</button>
          </div>
          <!-- Saved Lists Manager (Group 2) -->
          <div class="saved-lists-manager" style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
              <div class="custom-select-wrapper" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                <select id="savedListsGroup2Dropdown">
                  <option value="">-- ជ្រើសរើសថ្នាក់ដែលបានរក្សាទុក --</option>
                </select>
              </div>
              <span id="totalGroupNames2" class="total-count" style="margin: 0;">សរុប: ០ នាក់</span>
            </div>
            <div class="buttons" style="justify-content: flex-start; margin: 0;">
               <button id="savedListsGroup2BtnSave" style="background: linear-gradient(135deg, #f2994a, #f2c94c); color: white; font-size: 14px;" data-translate="btnSaveList">រក្សាទុកបញ្ជី</button>
               <button id="savedListsGroup2BtnLoad" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; font-size: 14px;" data-translate="btnLoadList">ប្រើប្រាស់</button>
               <button id="savedListsGroup2BtnRename" style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white; font-size: 14px;" data-translate="btnRenameList">កែប្រែ</button>
               <button id="savedListsGroup2BtnDelete" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; font-size: 14px;" data-translate="btnDeleteList">លុប</button>
            </div>
          </div>

          <div class="group-config" style="margin-top: 10px; padding: 5px;">
            <label for="groupCount2" data-translate="groupCountLabel">ចំនួនក្រុម:</label>
            <input type="number" id="groupCount2" min="1" placeholder="....." style="padding: 5px;"/>
            <button id="distributeGroups2" data-translate="distributeGroups">ចែកក្រុមចៃដន្យ</button>
          </div>
        </div>

        <div>
          <div class="table-scroll-wrapper">
            <table id="groupNamesTable2">
              <thead>
                <tr>
                  <th data-translate="thNo">ល.រ.</th>
                  <th data-translate="thName">ឈ្មោះសិស្ស</th>
                  <th data-translate="thAction">មុខងារ</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="buttons" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; justify-content: flex-start; align-items: center;">
            <button id="exportGroupNames2" data-translate="exportGroupNames" style="display: none;">ទាញ Excel</button>
            <button id="saveImage2" data-translate="saveImage">រក្សាទុករូបភាព</button>
            <button id="savePdf2" data-translate="savePdf">រក្សាទុក PDF</button>
            <button id="fullscreenBtn2" data-translate="fullscreenBtn">ពេញអេក្រង់</button>
          </div>
        </div>
      </div>

      <!-- Right Column: Groups -->
      <div id="groupWrapper2" style="flex:1; min-width: 0; position: relative;">
        <div id="groupsContainer2" class="groups-grid"></div>

        <!-- Floating Zoom Controls (Visible only in Fullscreen) -->
        <div class="fullscreen-zoom-controls">
           <button id="zoomInBtn2">🔍+</button>
           <button id="zoomResetBtn2">↺</button>
           <button id="zoomOutBtn2">🔍-</button>
        </div>

      </div>
    </div>
  </section>

  <!-- ================= Timer Section ================= -->
  <section id="timerSection" class="hidden">
    <div class="timer-controls">
      <h2 style="font-family: 'Khmer OS Muol Light'; color: #FFD700; margin-bottom: 20px; font-size: 45px; text-shadow: 2px 2px 5px rgba(0,0,0,0.3); letter-spacing: 1px;" data-translate="timerHeader">កំណត់ពេលវេលា</h2>
      <div id="timerDisplay" style="font-size: clamp(5rem, 15vw, 14rem); font-weight: bold; color: #FFD700; margin: 10px 0 30px 0; font-family: 'Times New Roman', serif; line-height: 1; text-shadow: 2px 2px 5px rgba(0,0,0,0.3); background: rgba(255,255,255,0.2); padding: 15px 40px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.4);">00:00</div>
      
      <div class="preset-buttons" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
        <button class="preset-btn" data-minutes="5" data-translate="timer5min">៥ នាទី</button>
        <button class="preset-btn" data-minutes="10" data-translate="timer10min">១០ នាទី</button>
        <button class="preset-btn" data-minutes="15" data-translate="timer15min">១៥ នាទី</button>
        <button class="preset-btn" data-minutes="30" data-translate="timer30min">៣០ នាទី</button>
        <button class="preset-btn" data-minutes="60" data-translate="timer60min">៦០ នាទី</button>
        <button class="preset-btn" data-minutes="90" data-translate="timer90min">៩០ នាទី</button>
        <button class="preset-btn" data-minutes="120" data-translate="timer120min">១២០ នាទី</button>
      </div>

      <div class="buttons" style="justify-content: center; margin-bottom: 10px; gap: 15px; flex-wrap: wrap; align-items: center;">
        <div style="display: flex; gap: 10px; background: rgba(255,255,255,0.3); padding: 10px; border-radius: 20px; flex-wrap: wrap; justify-content: center; align-items: center;">
          <input type="number" id="timerHourInput" placeholder="ម៉ោង" data-translate-placeholder="timerHour" min="0" style="width: 100px; padding: 6px; border-radius: 15px; border: none; background: #ffcdd2; color: #000; text-align: center; font-size: 14px; font-family: 'Khmer OS Battambang'; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
          <input type="number" id="timerMinuteInput" placeholder="នាទី" data-translate-placeholder="timerMinute" min="0" style="width: 100px; padding: 6px; border-radius: 15px; border: none; background: #c8e6c9; color: #000; text-align: center; font-size: 14px; font-family: 'Khmer OS Battambang'; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
          <input type="number" id="timerSecondInput" placeholder="វិនាទី" data-translate-placeholder="timerSecond" min="0" style="width: 100px; padding: 6px; border-radius: 15px; border: none; background: #bbdefb; color: #000; text-align: center; font-size: 14px; font-family: 'Khmer OS Battambang'; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
          <input type="color" id="timerColorPicker" value="#FFD700" style="width: 50px; height: 45px; border: none; cursor: pointer; background: transparent; padding: 0; border-radius: 10px;" title="ប្តូរពណ៌អក្សរ">
          <input type="color" id="timerBgColorPicker" value="#ffffff" style="width: 50px; height: 45px; border: none; cursor: pointer; background: transparent; padding: 0; border-radius: 10px;" title="ប្តូរពណ៌ផ្ទៃ">
          <button id="startTimer" data-translate="startTimer">ចាប់ផ្តើម</button>
          <button id="stopTimer" data-translate="stopTimer">បញ្ឈប់</button>
          <button id="resetTimer" data-translate="resetTimer">កំណត់ថ្មី</button>
          <button id="timerFullscreenBtn" data-translate="timerFullscreenBtn">ពេញអេក្រង់</button>
        </div>
      </div>

      <!-- Floating Zoom Controls (Visible only in Fullscreen) -->
      <div class="fullscreen-zoom-controls">
        <button id="zoomInBtnTimer">🔍+</button>
        <button id="zoomResetBtnTimer">↺</button>
        <button id="zoomOutBtnTimer">🔍-</button>
      </div>
    </div>
  </section>

  <!-- ================= Fishing Section ================= -->
  <section id="fishingSection" class="hidden">
    <div class="spin-content" style="display: flex; gap: 20px; align-items: flex-start;">
      <div style="width: 100%; max-width: calc(600px - 3cm);">
        <div class="controls" style="max-width: 100%;">
          <textarea id="fishingNameInput" placeholder="សូមបញ្ចូលឈ្មោះត្រង់នេះ (មួយជួរឈ្មោះមួយ)" data-translate-placeholder="fishingNameInputPlaceholder"></textarea>
          <div class="buttons">
            <button id="importFishingNames" data-translate="importFishingNames">បញ្ចូលបញ្ជីឈ្មោះ</button>
            <button id="copyFishingNames" data-translate="copyNames" style="background: linear-gradient(135deg, #00b09b, #96c93d);">📋 ចម្លងឈ្មោះ</button>
            <button id="clearFishingNames" data-translate="clearFishingNames">លុបចោល</button>
          </div>
          <!-- Saved Lists Manager (Fishing) -->
          <div class="saved-lists-manager" style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
              <div class="custom-select-wrapper" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                <select id="savedListsFishingDropdown">
                  <option value="">-- ជ្រើសរើសថ្នាក់ដែលបានរក្សាទុក --</option>
                </select>
              </div>
              <span id="totalFishingNames" class="total-count" style="margin: 0;">សរុប: ០ នាក់</span>
            </div>
            <div class="buttons" style="justify-content: flex-start; margin: 0;">
               <button id="savedListsFishingBtnSave" style="background: linear-gradient(135deg, #f2994a, #f2c94c); color: white; font-size: 14px;" data-translate="btnSaveList">រក្សាទុកបញ្ជី</button>
               <button id="savedListsFishingBtnLoad" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; font-size: 14px;" data-translate="btnLoadList">ប្រើប្រាស់</button>
               <button id="savedListsFishingBtnRename" style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white; font-size: 14px;" data-translate="btnRenameList">កែប្រែ</button>
               <button id="savedListsFishingBtnDelete" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; font-size: 14px;" data-translate="btnDeleteList">លុប</button>
            </div>
          </div>
        </div>
        <div class="table-scroll-wrapper">
          <table id="fishingNamesTable">
            <thead>
              <tr>
                <th data-translate="thNo">ល.រ.</th>
                <th data-translate="thName">ឈ្មោះសិស្ស</th>
                <th data-translate="thAction">មុខងារ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="export-history-buttons">
          <button id="exportFishingNames" data-translate="exportFishingNames" style="display: none;">ទាញ Excel</button>
          <button id="historyFishing" data-translate="historyLabel">ប្រវត្តិប្រតិបត្តិ</button>
          <button id="fishingFullscreenBtn" data-translate="fullscreenBtn">ពេញអេក្រង់</button>
          <label class="hide-names-btn">
            <input type="checkbox" id="hideFishNamesCheckbox">
            <span data-translate="hideNames">លាក់ឈ្មោះ</span>
          </label>
        </div>
      </div>
      <div style="flex: 1; min-width: 0; width: 100%;">
        <button id="startFishingBtn" data-translate="startFishingBtn">ចាប់ផ្តើមស្ទូចត្រី</button>
        <div class="fishing-container">
        <!-- Bubbles Layer -->
        <div class="bubbles-layer">
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
        </div>
        <canvas id="fishingCanvas"></canvas>
        <div id="fishingResultOverlay" class="hidden">
           <h2 id="fishingWinner"></h2>
           <div style="display: flex; gap: 15px; margin-top: 30px;">
             <button id="addFishingResultBtn" class="fishing-res-btn" data-translate="addFishingResultBtn">បន្ថែម</button>
             <button id="removeFishingResultBtn" class="fishing-res-btn" data-translate="removeFishingResultBtn">ដកចេញ</button>
             <button id="closeFishingResultBtn" class="fishing-res-btn" data-translate="closeFishingResultBtn">បិទ</button>
           </div>
        </div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  <span data-translate="footerText" style="font-family: 'Khmer OS Battambang', sans-serif;">&copy; 2025 NGSPL Smart Classroom បង្កើតឡើងដោយគ្រូបង្រៀននៃវិទ្យាល័យព្រែកលៀប</span>
</footer>

<!-- Help Modal (ផ្ទាំងជំនួយ) -->
<div id="helpModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 data-translate="helpTitle">របៀបប្រើប្រាស់</h2>
      <span id="closeHelp" class="close-btn">&times;</span>
    </div>
    <div class="modal-body">
      <ul id="helpList">
        <li data-translate="helpSpin"><strong>កង់បង្វិល៖</strong> បញ្ចូលឈ្មោះ រួចចុច "បង្វិល"។ អាចមើលប្រវត្តិ និងពេញអេក្រង់។</li>
        <li data-translate="helpGroup"><strong>បែងចែកក្រុម៖</strong> កំណត់ចំនួនក្រុម រួចចុចចែកក្រុម។ អាចអូសប្តូរសមាជិក, កែឈ្មោះក្រុម, ប្តូរពណ៌ និង Save ជា PDF/Image។</li>
        <li data-translate="helpFishing"><strong>ស្ទូចត្រី៖</strong> បញ្ចូលឈ្មោះ រួចចុច "ចាប់ផ្តើមស្ទូចត្រី" ដើម្បីជ្រើសរើសអ្នកឈ្នះ។</li>
        <li data-translate="helpTimer"><strong>កំណត់ម៉ោង៖</strong> ប្រើម៉ោងកំណត់ស្រាប់ ឬបញ្ចូលផ្ទាល់។ អាចប្តូរពណ៌ម៉ោងបាន។</li>
        <li data-translate="helpSave"><strong>រក្សាទុក៖</strong> អាច Save ជារូបភាព ឬ PDF (មានឈ្មោះសាលា) សម្រាប់ផ្នែកចែកក្រុម។</li>
        <li data-translate="helpSound"><strong>ការកំណត់៖</strong> ប្តូរភាសា (KH/EN), ប្តូរ Theme (ភ្លឺ/ងងឹត), និងបិទ/បើកសំឡេង។</li>
      </ul>
      <p style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; font-weight: bold; color: #555;">
        គេហទំព័រនេះបង្កើតដោយ ហេង ជានិច្ច គ្រូបង្រៀននៃវិទ្យាល័យព្រែកលៀប (កម្មវិធីសាលារៀនជំនាន់ថ្មី)
      </p>
    </div>
  </div>
</div>

<!-- Timeout Modal (ផ្ទាំងដល់ម៉ោងហើយ) -->
<div id="timeoutModal" class="modal" style="z-index: 2000;">
  <div class="modal-content">
    <div class="modal-body" style="padding: 40px;">
      <div class="timeout-icon">⏰</div>
      <h2 data-translate="timeoutTitle">ដល់ម៉ោងហើយ!</h2>
      <p style="font-size: 1.2rem; margin-bottom: 25px; opacity: 0.9;" data-translate="timeoutMsg">ពេលវេលាបានបញ្ចប់ហើយ</p>
      <button onclick="document.getElementById('timeoutModal').style.display='none'" data-translate="okBtn">យល់ព្រម</button>
    </div>
  </div>
</div>

<!-- Timer Warning Modal (ផ្ទាំងជូនដំណឹងបញ្ចូលម៉ោង) -->
<div id="timerWarningModal" class="modal" style="z-index: 2000;">
  <div class="modal-content">
    <div class="modal-body" style="padding: 40px;">
      <div class="timeout-icon">⚠️</div>
      <h2 data-translate="warningTitle">សូមពិនិត្យម្តងទៀត!</h2>
      <p style="font-size: 1.2rem; margin-bottom: 25px; opacity: 0.9;" data-translate="warningMsg">សូមបញ្ចូលចំនួនម៉ោង នាទី ឬវិនាទីឱ្យបានត្រឹមត្រូវ</p>
      <button onclick="document.getElementById('timerWarningModal').style.display='none'" data-translate="okBtn">យល់ព្រម</button>
    </div>
  </div>
</div>

<!-- Empty Input Modal (ផ្ទាំងជូនដំណឹងបញ្ចូលឈ្មោះ) -->
<div id="emptyInputModal" class="modal" style="z-index: 2000;">
  <div class="modal-content">
    <div class="modal-body" style="padding: 40px;">
      <div class="timeout-icon">📝</div>
      <h2 data-translate="emptyTitle">សូមបញ្ចូលឈ្មោះ!</h2>
      <p style="font-size: 1.2rem; margin-bottom: 25px; opacity: 0.9;" data-translate="emptyMsg">សូមបញ្ចូលឈ្មោះក្នុងប្រអប់ខាងលើជាមុនសិន</p>
      <button onclick="document.getElementById('emptyInputModal').style.display='none'" data-translate="okBtn">យល់ព្រម</button>
    </div>
  </div>
</div>

<!-- Save List Modal (ផ្ទាំងរក្សាទុកឈ្មោះថ្នាក់) -->
<div id="saveListModal" class="modal" style="z-index: 2000;">
  <div class="modal-content">
    <div class="modal-body" style="padding: 40px;">
      <div class="timeout-icon">💾</div>
      <h2 data-translate="saveListTitle">រក្សាទុកបញ្ជីឈ្មោះ</h2>
      <p style="font-size: 1.2rem; margin-bottom: 15px; opacity: 0.9;" data-translate="saveListMsg">សូមបញ្ចូលឈ្មោះថ្នាក់ (ឧ. ថ្នាក់ ៧ក):</p>
      <input type="text" id="saveListNameInput" placeholder="ឈ្មោះថ្នាក់..." style="color: #000;">
      <div style="display: flex; justify-content: center; gap: 15px;">
        <button id="confirmSaveListBtn" style="background: white; color: #11998e; padding: 10px 35px; font-size: 1.1rem;" data-translate="btnSaveList">រក្សាទុក</button>
        <button id="deleteListBtnInModal" style="background: #e74c3c; color: white; padding: 10px 35px; font-size: 1.1rem; display: none;" data-translate="btnDeleteList">លុប</button>
        <button onclick="document.getElementById('saveListModal').style.display='none'" style="background: #ff4757; color: white; padding: 10px 35px; font-size: 1.1rem;" data-translate="btnClose">បិទ</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal (ផ្ទាំងបញ្ជាក់ការលុប) -->
<div id="deleteConfirmModal" class="modal" style="z-index: 2000;">
  <div class="modal-content">
    <div class="modal-body" style="padding: 40px;">
      <div class="timeout-icon">🗑️</div>
      <h2 data-translate="deleteConfirmTitle">បញ្ជាក់ការលុប</h2>
      <p style="font-size: 1.2rem; margin-bottom: 25px; opacity: 0.9;" data-translate="deleteConfirmMsg">តើអ្នកពិតជាចង់លុបបញ្ជីនេះមែនទេ?</p>
      <div style="display: flex; justify-content: center; gap: 15px;">
        <button id="confirmDeleteBtn" style="background: white; color: #c0392b; padding: 10px 35px; font-size: 1.1rem;" data-translate="btnDeleteList">លុប</button>
        <button onclick="document.getElementById('deleteConfirmModal').style.display='none'" style="background: rgba(255,255,255,0.3); color: white; padding: 10px 35px; font-size: 1.1rem;" data-translate="btnClose">បិទ</button>
      </div>
    </div>
  </div>
</div>

<!-- No Names to Copy Modal (ផ្ទាំងគ្មានឈ្មោះសម្រាប់ចម្លង) -->
<div id="noNamesToCopyModal" class="modal" style="z-index: 2000;">
  <div class="modal-content">
    <div class="modal-body" style="padding: 40px;">
      <div class="timeout-icon">📋</div>
      <h2 data-translate="noNamesTitle">បញ្ជីទទេ!</h2>
      <p style="font-size: 1.2rem; margin-bottom: 25px; opacity: 0.9;" data-translate="noNamesMsg">គ្មានឈ្មោះសម្រាប់ចម្លងទេ</p>
      <button onclick="document.getElementById('noNamesToCopyModal').style.display='none'" data-translate="okBtn">យល់ព្រម</button>
    </div>
  </div>
</div>

<!-- Save Empty Modal (ផ្ទាំងបញ្ជីទទេពេលរក្សាទុក) -->
<div id="saveEmptyModal" class="modal" style="z-index: 2000;">
  <div class="modal-content">
    <div class="modal-body" style="padding: 40px;">
      <div class="timeout-icon">📂</div>
      <h2 data-translate="saveEmptyTitle">បញ្ជីទទេ!</h2>
      <p style="font-size: 1.2rem; margin-bottom: 25px; opacity: 0.9;" data-translate="saveEmptyMsg">សូមបញ្ចូលឈ្មោះសិស្សជាមុនសិន</p>
      <button onclick="document.getElementById('saveEmptyModal').style.display='none'" data-translate="okBtn">យល់ព្រម</button>
    </div>
  </div>
</div>

<!-- Success Modal (ផ្ទាំងជោគជ័យ) -->
<div id="successModal" class="modal" style="z-index: 2000;">
  <div class="modal-content">
    <div class="modal-body" style="padding: 40px;">
      <div class="timeout-icon">✅</div>
      <h2 id="successTitle">ជោគជ័យ!</h2>
      <p id="successMsg" style="font-size: 1.2rem; margin-bottom: 25px; opacity: 0.9;">ប្រតិបត្តិការជោគជ័យ</p>
      <button onclick="document.getElementById('successModal').style.display='none'" data-translate="okBtn">យល់ព្រម</button>
    </div>
  </div>
</div>

<!-- History Modal (ផ្ទាំងប្រវត្តិ) -->
<div id="historyModal" class="modal" style="z-index: 2000;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 data-translate="historyTitle">ប្រវត្តិប្រតិបត្តិការ</h2>
      <span class="close-btn" onclick="document.getElementById('historyModal').style.display='none'">&times;</span>
    </div>
    <div class="modal-body">
      <ul id="historyList" style="list-style: none; padding: 0; max-height: 300px; overflow-y: auto;"></ul>
      <div style="text-align: center; margin-top: 20px;">
        <button id="exportHistoryBtn" style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-family: 'Khmer OS Battambang'; margin-right: 5px;" data-translate="exportHistory">ទាញយកប្រវត្តិ (Excel)</button>
        <button id="clearHistoryBtn" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-family: 'Khmer OS Battambang';" data-translate="clearHistory">លុបប្រវត្តិ</button>
        <button onclick="document.getElementById('historyModal').style.display='none'" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-family: 'Khmer OS Battambang';" data-translate="btnClose">បិទ</button>
      </div>
    </div>
  </div>
</div>

<!-- Audio -->
<audio id="spinSound" src="spin.mp3" preload="auto"></audio>
<audio id="resultSound" src="result.mp3" preload="auto"></audio>
<audio id="applauseSound" src="applause.mp3" preload="auto"></audio>
<audio id="tickSound" src="tick.mp3" preload="auto"></audio>
<audio id="splashSound" src="splash.mp3" preload="auto"></audio>
<audio id="tensionSound" src="tension.mp3" preload="auto" loop></audio>
<audio id="clickSound" src="click.mp3" preload="auto"></audio>

<!-- CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script src="script.js"></script>

<script>
// Wrap everything in an IIFE to prevent conflicts with script.js
(() => {
  // Fallback for toKhmer if not defined in script.js
  if (typeof toKhmer === 'undefined') {
    window.toKhmer = (num) => {
      const khmerNums = ['០','១','២','៣','៤','៥','៦','៧','៨','៩'];
      return num.toString().replace(/[0-9]/g, w => khmerNums[w]);
    };
  }

  // Global History Storage (Moved to top)
  const loadHistory = (key) => {
    try {
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : [];
    } catch (e) { return []; }
  };
  const saveHistory = (key, data) => {
    localStorage.setItem(key, JSON.stringify(data));
  };

  let spinHistory = loadHistory('spinHistory');
  let groupHistory = loadHistory('groupHistory');
  let groupHistory2 = loadHistory('groupHistory2');
  let timerHistory = loadHistory('timerHistory');
  let fishingHistory = loadHistory('fishingHistory');

  // Script សម្រាប់គ្រប់គ្រងផ្ទាំងជំនួយ និងប៊ូតុងសំឡេង
  const helpBtn = document.getElementById('helpBtn');
  const helpModal = document.getElementById('helpModal');
  const closeHelp = document.getElementById('closeHelp');
  const toggleSoundBtn = document.getElementById('toggleSoundBtn');
  const themeToggleBtn = document.getElementById('themeToggleBtn');
  const langToggleBtn = document.getElementById('langToggleBtn');
  let isMuted = false;

  // Click Sound Logic (សំឡេង Click ពេលចុចប៊ូតុង)
  const clickSound = document.getElementById('clickSound');
  document.addEventListener('click', (e) => {
    const target = e.target.closest('button, .close-btn');
    if (target) {
      if (clickSound && !isMuted) {
        clickSound.currentTime = 0;
        clickSound.play().catch(() => {});
      }
    }
  });

  // Landing Page Logic (កូដសម្រាប់បិទផ្ទាំងស្វាគមន៍)
  const enterBtn = document.getElementById('enterBtn');
  const landingPage = document.getElementById('landingPage');
  
  // Snow Logic
  let snowInterval;
  function startSnow() {
    snowInterval = setInterval(() => {
      if (landingPage.classList.contains('landing-hidden')) return;
      const snowflake = document.createElement('div');
      snowflake.classList.add('snowflake');
      snowflake.style.left = Math.random() * 100 + 'vw';
      const size = Math.random() * 6 + 3;
      snowflake.style.width = size + 'px';
      snowflake.style.height = size + 'px';
      snowflake.style.opacity = Math.random() * 0.7 + 0.3;
      snowflake.style.animation = `fall ${Math.random() * 3 + 3}s linear infinite`;
      landingPage.appendChild(snowflake);
      setTimeout(() => snowflake.remove(), 6000);
    }, 100);
  }

  if (enterBtn && landingPage) {
    startSnow(); // ចាប់ផ្តើមធ្លាក់ព្រិល
    enterBtn.addEventListener('click', () => {
      landingPage.classList.add('landing-hidden');
      clearInterval(snowInterval); // ឈប់ធ្លាក់ពេលចូលកម្មវិធី
    });
  }

  helpBtn.onclick = () => helpModal.style.display = "block";
  closeHelp.onclick = () => helpModal.style.display = "none";
  
  // Handle closing modals when clicking outside
  window.addEventListener('click', (e) => {
    if(e.target == helpModal) helpModal.style.display = "none";
    if(e.target == document.getElementById('historyModal')) document.getElementById('historyModal').style.display = "none";
    if(e.target == document.getElementById('timeoutModal')) document.getElementById('timeoutModal').style.display = "none";
    if(e.target == document.getElementById('timerWarningModal')) document.getElementById('timerWarningModal').style.display = "none";
    if(e.target == document.getElementById('emptyInputModal')) document.getElementById('emptyInputModal').style.display = "none";
    if(e.target == document.getElementById('saveListModal')) document.getElementById('saveListModal').style.display = "none";
    if(e.target == document.getElementById('deleteConfirmModal')) document.getElementById('deleteConfirmModal').style.display = "none";
    if(e.target == document.getElementById('noNamesToCopyModal')) document.getElementById('noNamesToCopyModal').style.display = "none";
    if(e.target == document.getElementById('saveEmptyModal')) document.getElementById('saveEmptyModal').style.display = "none";
    if(e.target == document.getElementById('successModal')) document.getElementById('successModal').style.display = "none";
  });

  toggleSoundBtn.onclick = () => {
    isMuted = !isMuted;
    toggleSoundBtn.innerHTML = isMuted ? "🔇 បិទសំឡេង" : "🔊 បើកសំឡេង";
    document.querySelectorAll('audio').forEach(a => a.muted = isMuted);
  };

  // Theme Logic (Dark Mode)
  const currentTheme = localStorage.getItem('theme');
  if (currentTheme === 'dark') {
    document.body.classList.add('dark-mode');
    themeToggleBtn.innerHTML = '☀️ Light Mode';
  }

  themeToggleBtn.onclick = () => {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    themeToggleBtn.innerHTML = isDark ? '☀️ Light Mode' : '🌙 Dark Mode';
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  };

  // ================= LANGUAGE LOGIC =================
  let currentLang = 'kh';
  const translations = {
    kh: {
      randomCallTab: "ហៅឈ្មោះ ▼",
      spinTab: "បង្វិលចៃដន្យ",
      groupMenuTab: "ចែកក្រុម ▼",
      groupTab: "ចែកក្រុមចៃដន្យ",
      groupTab2: "សៀវភៅចែកក្រុម",
      timerTab: "កំណត់ពេលវេលា",
      fishingTab: "ស្ទូចត្រីចៃដន្យ",
      nameInputPlaceholder: "សូមបញ្ចូលឈ្មោះត្រង់នេះ",
      importNames: "បញ្ចូលបញ្ជីឈ្មោះ",
      clearNames: "លុបចោល",
      exportNames: "ទាញ Excel",
      spinButton: "បង្វិល",
      btnAdd: "បន្ថែម",
      btnRemove: "លុប",
      btnClose: "បិទ",
      groupNameInputPlaceholder: "សូមបញ្ចូលឈ្មោះត្រង់នេះ",
      importGroupNames: "បញ្ចូលបញ្ជីឈ្មោះ",
      clearGroupNames: "លុបចោល",
      groupCountLabel: "ចំនួនក្រុម:",
      distributeGroups: "ចែកក្រុមចៃដន្យ",
      exportGroupNames: "ទាញ Excel",
      saveImage: "រក្សាទុករូបភាព",
      savePdf: "រក្សាទុក PDF",
      fullscreenBtn: "ពេញអេក្រង់",
      zoomIn: "ពង្រីក (+)",
      zoomOut: "បង្រួម (-)",
      zoomReset: "កំណត់ដើម (Reset)",
      timerHeader: "កំណត់ពេលវេលា",
      timer5min: "៥ នាទី",
      timer10min: "១០ នាទី",
      timer15min: "១៥ នាទី",
      timer30min: "៣០ នាទី",
      timer60min: "៦០ នាទី",
      timer90min: "៩០ នាទី",
      timer120min: "១២០ នាទី",
      timerHour: "ម៉ោង",
      timerMinute: "នាទី",
      timerSecond: "វិនាទី",
      startTimer: "ចាប់ផ្តើម",
      stopTimer: "បញ្ឈប់",
      resetTimer: "កំណត់ថ្មី",
      timerFullscreenBtn: "ពេញអេក្រង់",
      fishingNameInputPlaceholder: "សូមបញ្ចូលឈ្មោះត្រង់នេះ (មួយជួរឈ្មោះមួយ)",
      importFishingNames: "បញ្ចូលបញ្ជីឈ្មោះ",
      clearFishingNames: "លុបចោល",
      exportFishingNames: "ទាញ Excel",
      startFishingBtn: "ចាប់ផ្តើមស្ទូចត្រី",
      addFishingResultBtn: "បន្ថែម",
      removeFishingResultBtn: "លុប",
      closeFishingResultBtn: "បិទ",
      footerText: "&copy; 2025 NGSPL Smart Classroom បង្កើតឡើងដោយគ្រូបង្រៀននៃវិទ្យាល័យព្រែកលៀប",
      helpTitle: "របៀបប្រើប្រាស់",
      helpSpin: "<strong>កង់បង្វិល៖</strong> បញ្ចូលឈ្មោះ រួចចុច \"បង្វិល\"។ អាចមើលប្រវត្តិ និងពេញអេក្រង់។",
      helpGroup: "<strong>បែងចែកក្រុម៖</strong> កំណត់ចំនួនក្រុម រួចចុចចែកក្រុម។ អាចអូសប្តូរសមាជិក, កែឈ្មោះក្រុម, ប្តូរពណ៌ និង Save ជា PDF/Image។",
      helpFishing: "<strong>ស្ទូចត្រី៖</strong> បញ្ចូលឈ្មោះ រួចចុច \"ចាប់ផ្តើមស្ទូចត្រី\" ដើម្បីជ្រើសរើសអ្នកឈ្នះ។",
      helpTimer: "<strong>កំណត់ម៉ោង៖</strong> ប្រើម៉ោងកំណត់ស្រាប់ ឬបញ្ចូលផ្ទាល់។ អាចប្តូរពណ៌ម៉ោងបាន។",
      helpSave: "<strong>រក្សាទុក៖</strong> អាច Save ជារូបភាព ឬ PDF (មានឈ្មោះសាលា) សម្រាប់ផ្នែកចែកក្រុម។",
      helpSound: "<strong>ការកំណត់៖</strong> ប្តូរភាសា (KH/EN), ប្តូរ Theme (ភ្លឺ/ងងឹត), និងបិទ/បើកសំឡេង។",
      timeoutTitle: "ដល់ម៉ោងហើយ!",
      timeoutMsg: "ពេលវេលាបានបញ្ចប់ហើយ",
      warningTitle: "សូមពិនិត្យម្តងទៀត!",
      warningMsg: "សូមបញ្ចូលចំនួនម៉ោង នាទី ឬវិនាទីឱ្យបានត្រឹមត្រូវ",
      emptyTitle: "សូមបញ្ចូលឈ្មោះ!",
      emptyMsg: "សូមបញ្ចូលឈ្មោះក្នុងប្រអប់ខាងលើជាមុនសិន",
      okBtn: "យល់ព្រម",
      thNo: "ល.រ.",
      thName: "ឈ្មោះសិស្ស",
      thAction: "មុខងារ",
      historyLabel: "ប្រវត្តិប្រតិបត្តិ",
      historyTitle: "ប្រវត្តិប្រតិបត្តិការ",
      clearHistory: "លុបប្រវត្តិ",
      exportHistory: "ទាញយកប្រវត្តិ (Excel)",
      hideNames: "លាក់ឈ្មោះ",
      btnSaveList: "រក្សាទុកបញ្ជី",
      btnLoadList: "ប្រើប្រាស់",
      btnRenameList: "កែប្រែ",
      btnDeleteList: "លុប",
      saveListTitle: "រក្សាទុកបញ្ជីឈ្មោះ",
      saveListMsg: "សូមបញ្ចូលឈ្មោះថ្នាក់ (ឧ. ថ្នាក់ ៧ក):",
      renameListTitle: "ប្តូរឈ្មោះបញ្ជី",
      renameListMsg: "សូមបញ្ចូលឈ្មោះថ្មី:",
      copyNames: "📋 ចម្លងឈ្មោះ",
      deleteConfirmTitle: "បញ្ជាក់ការលុប",
      deleteConfirmMsg: "តើអ្នកពិតជាចង់លុបបញ្ជីនេះមែនទេ?",
      noNamesTitle: "បញ្ជីទទេ!",
      noNamesMsg: "គ្មានឈ្មោះសម្រាប់ចម្លងទេ",
      saveEmptyTitle: "បញ្ជីទទេ!",
      saveEmptyMsg: "សូមបញ្ចូលឈ្មោះសិស្សជាមុនសិន",
      repLabel: "អ្នកតំណាងក្រុម"
    },
    en: {
      randomCallTab: "Random Call ▼",
      spinTab: "Name Picker",
      groupMenuTab: "Groups ▼",
      groupTab: "Group Divider",
      groupTab2: "Group Book",
      timerTab: "Timer",
      fishingTab: "Fishing Game",
      nameInputPlaceholder: "Enter names here...",
      importNames: "Import List",
      clearNames: "Clear",
      exportNames: "Download Excel",
      spinButton: "SPIN",
      btnAdd: "Add",
      btnRemove: "Remove",
      btnClose: "Close",
      groupNameInputPlaceholder: "Enter names here...",
      importGroupNames: "Import List",
      clearGroupNames: "Clear",
      groupCountLabel: "Groups:",
      distributeGroups: "Distribute",
      exportGroupNames: "Download Excel",
      saveImage: "Save Image",
      savePdf: "Save PDF",
      fullscreenBtn: "Fullscreen",
      zoomIn: "Zoom In (+)",
      zoomOut: "Zoom Out (-)",
      zoomReset: "Reset Zoom",
      timerHeader: "Timer",
      timer5min: "5 Min",
      timer10min: "10 Min",
      timer15min: "15 Min",
      timer30min: "30 Min",
      timer60min: "60 Min",
      timer90min: "90 Min",
      timer120min: "120 Min",
      timerHour: "Hour",
      timerMinute: "Min",
      timerSecond: "Sec",
      startTimer: "Start",
      stopTimer: "Stop",
      resetTimer: "Reset",
      timerFullscreenBtn: "Fullscreen",
      fishingNameInputPlaceholder: "Enter names here (one per line)",
      importFishingNames: "Import List",
      clearFishingNames: "Clear",
      exportFishingNames: "Download Excel",
      startFishingBtn: "Start Fishing",
      addFishingResultBtn: "Add",
      removeFishingResultBtn: "Remove",
      closeFishingResultBtn: "Close",
      footerText: "&copy; 2025 NGSPL Smart Classroom. Created by Prek Leap High School Teachers.",
      helpTitle: "How to Use",
      helpSpin: "<strong>Name Picker:</strong> Enter names and click 'SPIN'. Features History & Fullscreen.",
      helpGroup: "<strong>Groups:</strong> Set group count & distribute. Drag & drop members, edit group names/colors, and Save as PDF/Image.",
      helpFishing: "<strong>Fishing:</strong> Enter names and click 'Start Fishing' to pick a winner.",
      helpTimer: "<strong>Timer:</strong> Use presets or custom time. Customizable colors.",
      helpSave: "<strong>Save:</strong> Export groups as Image or PDF (with school header).",
      helpSound: "<strong>Settings:</strong> Toggle Language, Theme (Dark/Light), and Sound.",
      timeoutTitle: "Time's Up!",
      timeoutMsg: "The timer has finished.",
      warningTitle: "Check Input!",
      warningMsg: "Please enter valid hours, minutes, or seconds.",
      emptyTitle: "Input Empty!",
      emptyMsg: "Please enter names in the box first.",
      okBtn: "OK",
      thNo: "No.",
      thName: "Name",
      thAction: "Action",
      historyLabel: "History Log",
      historyTitle: "History Log",
      clearHistory: "Clear History",
      exportHistory: "Export History (Excel)",
      hideNames: "Hide Names",
      btnSaveList: "Save List",
      btnLoadList: "Load",
      btnRenameList: "Rename",
      btnDeleteList: "Delete",
      saveListTitle: "Save List",
      saveListMsg: "Enter Class Name (e.g. 7A):",
      renameListTitle: "Rename List",
      renameListMsg: "Enter new name:",
      copyNames: "📋 Copy Names",
      deleteConfirmTitle: "Confirm Deletion",
      deleteConfirmMsg: "Are you sure you want to delete this list?",
      noNamesTitle: "Empty List!",
      noNamesMsg: "No names to copy.",
      saveEmptyTitle: "Empty List!",
      saveEmptyMsg: "Please enter student names first.",
      repLabel: "Representative"
    }
  };

  function setLanguage(lang) {
    currentLang = lang;
    window.currentLang = lang; // ដាក់ឱ្យ script.js អាចប្រើបាន
    langToggleBtn.innerHTML = lang === 'kh' ? '🌐 ភាសា: KH' : '🌐 Language: EN';
    
    // Update Text Content
    document.querySelectorAll('[data-translate]').forEach(el => {
      const key = el.getAttribute('data-translate');
      if(translations[lang][key]) {
        el.innerHTML = translations[lang][key];
      }
    });

    // Update Placeholders
    document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
      const key = el.getAttribute('data-translate-placeholder');
      if(translations[lang][key]) {
        el.placeholder = translations[lang][key];
      }
    });

    // Update Dynamic Content (Fishing Table)
    renderFishingTable();
    
    // Update Total Counts and Table Buttons for Spin and Group sections
    const label = lang === 'kh' ? 'សរុប: ' : 'Total: ';
    const unit = lang === 'kh' ? ' នាក់' : ' Persons';
    
    const updateSection = (dataArray, tableId, totalElId) => {
      // 1. Update Total Count
      let count = 0;
      if (typeof dataArray !== 'undefined') {
        count = dataArray.length;
      } else {
        // Fallback: Count table rows if array is not accessible
        const tbody = document.querySelector(`#${tableId} tbody`);
        if (tbody) count = tbody.children.length;
      }
      const countStr = lang === 'kh' ? toKhmer(count) : count;
      const el = document.getElementById(totalElId);
      if (el) el.textContent = `${label}${countStr}${unit}`;

      // 2. Update Table Buttons (Add/Remove)
      const table = document.getElementById(tableId);
      if (table) {
        table.querySelectorAll('button').forEach(btn => {
          const txt = btn.textContent.trim();
          if (txt === 'Add' || txt === 'បន្ថែម') btn.textContent = lang === 'kh' ? 'បន្ថែម' : 'Add';
          if (txt === 'Remove' || txt === 'លុប' || txt === 'បិទ' || txt === 'Delete') btn.textContent = lang === 'kh' ? 'លុប' : 'Remove';
        });
      }
    };

    updateSection(window.names, 'namesTable', 'totalNames');
    updateSection(window.groupNames, 'groupNamesTable', 'totalGroupNames');
    updateSection(window.groupNames2, 'groupNamesTable2', 'totalGroupNames2');

    // Refresh Groups to apply translation (Group & Copy)
    if (typeof renderGroups === 'function') renderGroups();
    if (typeof renderGroups2 === 'function') renderGroups2();
  }

  langToggleBtn.onclick = () => {
    setLanguage(currentLang === 'kh' ? 'en' : 'kh');
  };

  // Timer Color Picker Logic
  const timerColorPicker = document.getElementById('timerColorPicker');
  const timerDisplay = document.getElementById('timerDisplay');
  if (timerColorPicker && timerDisplay) {
    const savedColor = localStorage.getItem('timerColor');
    if (savedColor) {
      timerColorPicker.value = savedColor;
      timerDisplay.style.color = savedColor;
    }
    timerColorPicker.addEventListener('input', (e) => {
      timerDisplay.style.color = e.target.value;
      localStorage.setItem('timerColor', e.target.value);
    });
    const timerBgColorPicker = document.getElementById('timerBgColorPicker');
    if (timerBgColorPicker) {
      timerBgColorPicker.addEventListener('input', (e) => {
        timerDisplay.style.background = e.target.value;
      });
    }
  }

  // Header Color Picker Logic
  const headerColorInput = document.getElementById('headerColorInput');
  const header = document.querySelector('header');
  if (headerColorInput && header) {
    headerColorInput.addEventListener('input', (e) => {
      header.style.background = e.target.value;
    });
  }

  // Timer Fullscreen Logic
  const timerFullscreenBtn = document.getElementById('timerFullscreenBtn');
  if (timerFullscreenBtn) {
    timerFullscreenBtn.onclick = () => {
      const timerSection = document.getElementById('timerSection');
      if (!document.fullscreenElement && timerSection) timerSection.requestFullscreen().catch(err => console.log(err));
      else if (document.exitFullscreen) document.exitFullscreen();
    };
  }

  // Group Fullscreen Logic
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  if (fullscreenBtn) {
    fullscreenBtn.onclick = () => {
      const wrapper = document.getElementById('groupWrapper');
      if (!document.fullscreenElement && wrapper) wrapper.requestFullscreen().catch(err => console.log(err));
      else if (document.exitFullscreen) document.exitFullscreen();
    };
  }

  // Auto-adjust Grid Layout in Fullscreen (រៀបចំជួរដេក/ឈរឱ្យស្មើគ្នា)
  document.addEventListener('fullscreenchange', () => {
    const wrapper = document.getElementById('groupWrapper');
    const container = document.getElementById('groupsContainer');
    
    if (document.fullscreenElement === wrapper && container) {
      const count = container.children.length;
      if (count > 0) {
        const cols = Math.ceil(Math.sqrt(count));
        container.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      }
    } else if (container) {
      container.style.gridTemplateColumns = '';
    }
  });

  // Group 2 Fullscreen Logic
  const fullscreenBtn2 = document.getElementById('fullscreenBtn2');
  if (fullscreenBtn2) {
    fullscreenBtn2.onclick = () => {
      const wrapper = document.getElementById('groupWrapper2');
      if (!document.fullscreenElement && wrapper) wrapper.requestFullscreen().catch(err => console.log(err));
      else if (document.exitFullscreen) document.exitFullscreen();
    };
  }

  // Spin Fullscreen Logic
  const spinFullscreenBtn = document.getElementById('spinFullscreenBtn');
  if (spinFullscreenBtn) {
    spinFullscreenBtn.onclick = () => {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else if (document.exitFullscreen) document.exitFullscreen();
    };
  }

  // Fishing Fullscreen Logic
  const fishingFullscreenBtn = document.getElementById('fishingFullscreenBtn');
  if (fishingFullscreenBtn) {
    fishingFullscreenBtn.onclick = () => {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else if (document.exitFullscreen) document.exitFullscreen();
    };
  }

  // ================= FISHING GAME LOGIC =================
  const fishingTab = document.getElementById('fishingTab');
  const fishingSection = document.getElementById('fishingSection');
  const fishingCanvas = document.getElementById('fishingCanvas');
  const fishingCtx = fishingCanvas.getContext('2d');
  const startFishingBtn = document.getElementById('startFishingBtn');
  const fishingNameInput = document.getElementById('fishingNameInput');
  const totalFishingNames = document.getElementById('totalFishingNames');
  const fishingResultOverlay = document.getElementById('fishingResultOverlay');
  const fishingWinner = document.getElementById('fishingWinner');
  const addFishingResultBtn = document.getElementById('addFishingResultBtn');
  const removeFishingResultBtn = document.getElementById('removeFishingResultBtn');
  const closeFishingResultBtn = document.getElementById('closeFishingResultBtn');

  // Fishing Game Variables (Moved up to avoid TDZ error)
  let fishes = [];
  let fishingNames = ["ជានិច្ច", "ចីរកាល", "សុនិតា"];
  window.fishingNames = fishingNames; 
  let bubbles = [];
  let splashes = [];
  let fireParticles = [];
  let hook = { x: 0, y: -50, state: 'idle', target: null }; 
  let animationId;
  let isFishingActive = false;

  const fishImg = new Image();
  fishImg.src = 'fish.png';

  // Tab Switching Logic override to include Fishing
  const navTabs = ['spinTab', 'groupTab', 'groupTab2', 'fishingTab', 'timerTab'];
  const contentSections = ['spinSection', 'groupSection', 'groupSection2', 'fishingSection', 'timerSection'];
  const pageClasses = ['page-spin', 'page-group', 'page-magic', 'page-fishing', 'page-timer'];

  navTabs.forEach((tId, index) => {
    const btn = document.getElementById(tId);
    if(btn) {
      btn.addEventListener('click', () => {
        localStorage.setItem('activeTab', tId); // រក្សាទុកឈ្មោះ Tab ដែលបានចុច
        
        // Change Body Background
        document.body.classList.remove(...pageClasses);
        document.body.classList.add(pageClasses[index]);

        // Hide all sections
        contentSections.forEach(sId => document.getElementById(sId).classList.add('hidden'));
        // Remove active class from all tabs
        navTabs.forEach(tabId => document.getElementById(tabId).classList.remove('active'));
        
        // Remove active class from all dropdown buttons
        document.querySelectorAll('.dropbtn').forEach(b => b.classList.remove('active'));

        // Show target
        document.getElementById(contentSections[index]).classList.remove('hidden');
        btn.classList.add('active');
        
        // Highlight parent dropdown if exists
        const dropdown = btn.closest('.dropdown');
        if (dropdown) {
          const dropBtn = dropdown.querySelector('.dropbtn');
          if (dropBtn) dropBtn.classList.add('active');

          // Auto-collapse dropdown (បិទ Dropdown ដោយស្វ័យប្រវត្តិ)
          const dropContent = btn.closest('.dropdown-content');
          if (dropContent) {
            dropContent.style.display = 'none';
            setTimeout(() => dropContent.style.display = '', 50);
          }
        }

        // Stop audio from other tabs if function exists
        if (typeof window.stopAllAudio === 'function') window.stopAllAudio();

        if(tId === 'fishingTab') {
            if (!isFishingActive) {
                isFishingActive = true;
                resizeCanvas();
                initFish();
                drawGame();
            }
        } else {
            isFishingActive = false;
            cancelAnimationFrame(animationId);
        }
      });
    }
  });

  // Restore active tab on load (បើកមីនុយចុងក្រោយមកវិញពេល Refresh)
  const savedTab = localStorage.getItem('activeTab');
  if (savedTab && document.getElementById(savedTab)) {
    document.getElementById(savedTab).click();
  } else {
    const spinTab = document.getElementById('spinTab');
    if (spinTab) spinTab.click();
  }

  function resizeCanvas() {
    fishingCanvas.width = fishingCanvas.parentElement.clientWidth;
    fishingCanvas.height = fishingCanvas.parentElement.clientHeight;
    hook.x = fishingCanvas.width / 2;
  }
  window.addEventListener('resize', resizeCanvas);

  // Table Logic
  const fishingTableBody = document.querySelector('#fishingNamesTable tbody');

  function renderFishingTable() {
    fishingTableBody.innerHTML = '';
    fishingNames.forEach((name, i) => {
      const tr = document.createElement('tr');
      const no = currentLang === 'kh' ? toKhmer(i + 1) : (i + 1);
      const btnAdd = currentLang === 'kh' ? 'បន្ថែម' : 'Add';
      const btnRemove = currentLang === 'kh' ? 'លុប' : 'Remove';
      tr.innerHTML = `
        <td>${no}</td>
        <td>${name}</td>
        <td>
          <div class="table-buttons">
            <button class="btn-add" onclick="addFishingName(${i})">${btnAdd}</button>
            <button class="btn-remove" onclick="removeFishingName(${i})">${btnRemove}</button>
          </div>
        </td>`;
      fishingTableBody.appendChild(tr);
    });
    
    const totalCount = currentLang === 'kh' ? toKhmer(fishingNames.length) : fishingNames.length;
    const totalLabel = currentLang === 'kh' ? 'សរុប: ' : 'Total: ';
    const unitLabel = currentLang === 'kh' ? ' នាក់' : ' Persons';
    totalFishingNames.textContent = `${totalLabel}${totalCount}${unitLabel}`;
    
    // Fix: Ensure canvas is sized correctly and game loop is running
    if (fishingCanvas.offsetParent) {
        resizeCanvas();
        initFish();
        if (isFishingActive) cancelAnimationFrame(animationId);
        isFishingActive = true;
        drawGame();
    } else {
        initFish();
    }
  }

  window.addFishingName = i => {
    fishingNames.splice(i + 1, 0, fishingNames[i]);
    renderFishingTable();
  };

  window.removeFishingName = i => {
    fishingNames.splice(i, 1);
    renderFishingTable();
  };

  document.getElementById('clearFishingNames').onclick = () => {
      fishingNames = [];
      window.fishingNames = fishingNames;
      fishingNameInput.value = '';
      renderFishingTable();
  };

  document.getElementById('importFishingNames').onclick = () => {
      const val = fishingNameInput.value;
      if (val.trim()) {
        fishingNames = val.split(/\r?\n/).map(n => n.trim()).filter(Boolean);
        window.fishingNames = fishingNames;
        renderFishingTable();
      } else {
        document.getElementById('emptyInputModal').style.display = 'block';
      }
  };

  class Bubble {
    constructor() {
      this.x = Math.random() * fishingCanvas.width;
      this.y = fishingCanvas.height + 10;
      this.size = Math.random() * 5 + 2;
      this.speed = Math.random() * 1 + 0.5;
    }
    update() {
      this.y -= this.speed;
      this.x += Math.sin(this.y * 0.05) * 0.5;
    }
    draw() {
      fishingCtx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
      fishingCtx.lineWidth = 1;
      fishingCtx.beginPath();
      fishingCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      fishingCtx.stroke();
      fishingCtx.fillStyle = 'rgba(255, 255, 255, 0.2)';
      fishingCtx.beginPath();
      fishingCtx.arc(this.x - this.size*0.3, this.y - this.size*0.3, this.size*0.2, 0, Math.PI * 2);
      fishingCtx.fill();
    }
  }

  class SplashParticle {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.size = Math.random() * 3 + 2;
      this.speedX = (Math.random() - 0.5) * 4;
      this.speedY = -Math.random() * 3 - 2;
      this.gravity = 0.2;
      this.life = 1.0;
    }
    update() {
      this.x += this.speedX;
      this.y += this.speedY;
      this.speedY += this.gravity;
      this.life -= 0.03;
    }
    draw() {
      fishingCtx.fillStyle = `rgba(255, 255, 255, ${this.life})`;
      fishingCtx.beginPath();
      fishingCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      fishingCtx.fill();
    }
  }

  class Ripple {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.radius = 5;
      this.life = 1;
    }
    update() {
      this.radius += 3;
      this.life -= 0.03;
    }
    draw() {
      fishingCtx.strokeStyle = `rgba(255, 255, 255, ${this.life})`;
      fishingCtx.lineWidth = 3 * this.life;
      fishingCtx.beginPath();
      // Draw Ellipse for perspective (oval shape)
      fishingCtx.ellipse(this.x, this.y, this.radius, this.radius * 0.3, 0, 0, Math.PI * 2);
      fishingCtx.stroke();
    }
  }

  class FireParticle {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.size = Math.random() * 8 + 4;
      this.speedX = (Math.random() - 0.5) * 8;
      this.speedY = (Math.random() - 0.5) * 8;
      this.life = 1.0;
      this.color = `hsl(${Math.random() * 60}, 100%, 50%)`; // Red/Orange/Yellow
    }
    update() {
      this.x += this.speedX;
      this.y += this.speedY;
      this.life -= 0.02;
      this.size *= 0.95;
    }
    draw() {
      fishingCtx.globalAlpha = this.life;
      fishingCtx.fillStyle = this.color;
      fishingCtx.beginPath();
      fishingCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      fishingCtx.fill();
      fishingCtx.globalAlpha = 1.0;
    }
  }

  class Fish {
    constructor(name, index, total) {
      this.name = name;
      // Distribute Y vertically to avoid clustering (បែងចែកកម្ពស់កុំឱ្យជាន់គ្នា)
      const safeHeight = Math.max(50, fishingCanvas.height - 140);
      const step = safeHeight / (total || 1);
      this.y = 80 + (step * index) + (Math.random() * step * 0.2);
      this.x = Math.random() * (fishingCanvas.width - 100) + 50;
        this.speed = (Math.random() * 0.8 + 0.4) * (Math.random() < 0.5 ? 1 : -1);
      this.hue = Math.random() * 360;
      this.secondaryHue = (this.hue + 30 + Math.random() * 60) % 360; // ពណ៌បន្ថែមសម្រាប់លាយ
      this.saturation = 80 + Math.random() * 20;
      this.lightness = 50 + Math.random() * 10;
      this.size = 30;
      this.tailAngle = 0;
      this.baseY = this.y;
      this.timeOffset = Math.random() * 100;
      this.cachedFontSize = 0;
      this.textWidth = 0;
    }
    update() {
      // Natural Movement (Burst & Glide) - ធ្វើឱ្យត្រីហែលមានសន្ទុះខ្លាំងខ្សោយដូចត្រីពិត
      const time = Date.now() / 1000;
      const burst = Math.sin(time * 3 + this.timeOffset) * 0.3 + 1; // Speed multiplier (0.7 to 1.3)

      // 1. SCATTER: When hook is dropping, fish move away (Radial Scatter - គេចគ្រប់ទិស)
      if (hook.state === 'dropping') {
        const dx = this.x - hook.x;
        const dy = this.y - hook.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        // If within range, swim away fast in all directions (Radial)
        if (dist < 250) {
           const angle = Math.atan2(dy, dx);
           const escapeSpeed = 8;
           
           this.x += Math.cos(angle) * escapeSpeed;
           this.y += Math.sin(angle) * escapeSpeed;
           
           // Face away from hook
           if (Math.abs(dx) > 5) {
             this.speed = (dx > 0 ? Math.abs(this.speed) : -Math.abs(this.speed));
           }
        } else {
           this.x += this.speed * burst;
           // Return to base Y slowly
           this.y += (this.baseY - this.y) * 0.02;
        }
      }
      // 2. TARGET ONLY: When hook is waiting, only target fish swims to it
      else if (hook.state === 'waiting' && hook.target === this && (Date.now() - hook.waitStartTime > 5000)) {
        const dx = hook.x - this.x;
        const dy = (hook.y + 10) - this.y;
        
        this.y += dy * 0.08;
        if (Math.abs(dx) > 5) {
          this.x += (dx > 0 ? 8 : -8);
          this.speed = (dx > 0 ? Math.abs(this.speed) : -Math.abs(this.speed));
        }
      }
      // 3. NORMAL / CAUGHT
      else {
         // If caught, do nothing (position handled by drawGame)
         if ((hook.state === 'biting' || hook.state === 'reeling') && hook.target === this) {
             // Do nothing, controlled by hook
         } else {
             // Normal swim with more organic Y movement (Complex Wave)
             this.x += this.speed * burst;
             
             // Combine two sine waves for less robotic vertical movement
             const wave1 = Math.sin(time + this.timeOffset) * 15;
             const wave2 = Math.sin(time * 0.5 + this.timeOffset * 2) * 10;
             const targetY = this.baseY + wave1 + wave2;
             
             this.y += (targetY - this.y) * 0.1; // Smooth lerp
             
             // Random turn
             if (Math.random() < 0.005) this.speed = -this.speed;
         }
      }

      this.tailAngle += 0.1;

      // SEPARATION: Prevent clustering (កុំឱ្យត្រីផ្តុំគ្នា ឬជាន់គ្នា)
      if (hook.state !== 'reeling' && hook.state !== 'biting') {
        fishes.forEach(other => {
          if (other !== this) {
            const dx = this.x - other.x;
            const dy = this.y - other.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const minDist = 80; // គម្លាតអប្បបរមារវាងត្រី (ប្រហែលទំហំត្រី)

            if (dist < minDist && dist > 0) {
              // တွန်းចេញពីគ្នា (Push away)
              const force = (minDist - dist) / minDist; 
              const pushX = (dx / dist) * force * 3; 
              const pushY = (dy / dist) * force * 3;
              
              this.x += pushX;
              this.y += pushY;
              
              // កែសម្រួល BaseY បន្តិចដើម្បីកុំឱ្យវាត្រឡប់មកកន្លែងដើមវិញភ្លាមៗ
              this.baseY += pushY * 0.1;
            }
          }
        });
      }
      
      // ត្រីហែលបកក្រោយពេលដល់គែម (Bounce)
      if (this.x > fishingCanvas.width - 50) {
        this.x = fishingCanvas.width - 50;
        this.speed = -Math.abs(this.speed);
      } else if (this.x < 50) {
        this.x = 50;
        this.speed = Math.abs(this.speed);
      }
    }
    draw() {
      fishingCtx.save();
      fishingCtx.translate(this.x, this.y);
      if (this.speed < 0) fishingCtx.scale(-1, 1);
      
      if (fishImg.complete && fishImg.naturalHeight !== 0) {
        const w = 80;
        const h = 50;
        fishingCtx.drawImage(fishImg, -w / 2, -h / 2, w, h);
      } else {
        // === COLORFUL & BEAUTIFUL FISH DESIGN ===
        
        // 1. Tail (Gradient & Fancy Shape)
        fishingCtx.save();
        fishingCtx.translate(-this.size * 0.6, 0);
        fishingCtx.rotate(Math.sin(this.tailAngle) * 0.8); // More vigorous wag
        
        const tailGrad = fishingCtx.createLinearGradient(-25, 0, 0, 0);
        tailGrad.addColorStop(0, `hsl(${this.secondaryHue}, ${this.saturation}%, ${this.lightness - 10}%)`);
        tailGrad.addColorStop(1, `hsl(${this.hue}, ${this.saturation}%, ${this.lightness}%)`);
        fishingCtx.fillStyle = tailGrad;

        fishingCtx.beginPath();
        fishingCtx.moveTo(0, 0);
        fishingCtx.quadraticCurveTo(-15, -15, -28, -22); // Top tip
        fishingCtx.quadraticCurveTo(-20, 0, -28, 22);   // Bottom tip
        fishingCtx.quadraticCurveTo(-15, 15, 0, 0);
        fishingCtx.fill();
        fishingCtx.restore();
        
        // 2. Fins (Dorsal & Ventral)
        fishingCtx.fillStyle = `hsla(${this.secondaryHue}, ${this.saturation}%, ${this.lightness}%, 0.9)`;
        
        // Dorsal Fin (Top)
        fishingCtx.beginPath();
        fishingCtx.moveTo(-10, -this.size/2);
        fishingCtx.bezierCurveTo(0, -this.size - 12, 15, -this.size - 8, 22, -this.size/2);
        fishingCtx.fill();

        // Ventral Fin (Bottom)
        fishingCtx.beginPath();
        fishingCtx.moveTo(-5, this.size/2);
        fishingCtx.quadraticCurveTo(5, this.size + 8, 18, this.size/2);
        fishingCtx.fill();

        // Pectoral Fin (Side - Animated)
        fishingCtx.save();
        fishingCtx.translate(5, 5);
        fishingCtx.rotate(Math.sin(this.tailAngle * 2) * 0.3);
        fishingCtx.fillStyle = `hsla(${this.secondaryHue}, ${this.saturation}%, ${this.lightness + 15}%, 0.8)`;
        fishingCtx.beginPath();
        fishingCtx.ellipse(0, 0, 14, 7, Math.PI / 5, 0, Math.PI * 2);
        fishingCtx.fill();
        fishingCtx.restore();

        // 3. Body (Vibrant Gradient)
        const bodyGrad = fishingCtx.createRadialGradient(0, -5, 2, 0, 0, this.size + 5);
        bodyGrad.addColorStop(0, `hsl(${this.hue}, ${this.saturation}%, ${this.lightness + 20}%)`); // Highlight
        bodyGrad.addColorStop(0.5, `hsl(${this.hue}, ${this.saturation}%, ${this.lightness}%)`); // Main
        bodyGrad.addColorStop(1, `hsl(${this.hue}, ${this.saturation}%, ${this.lightness - 20}%)`); // Shadow
        fishingCtx.fillStyle = bodyGrad;
        
        fishingCtx.beginPath();
        // Mouth logic
        const isBiting = (hook.state === 'biting' && hook.target === this);
        if (isBiting) {
             fishingCtx.moveTo(this.size, -8);
             fishingCtx.lineTo(this.size - 10, 0);
             fishingCtx.lineTo(this.size, 8);
        } else {
             fishingCtx.moveTo(this.size, 0);
        }
        
        // Top curve
        fishingCtx.bezierCurveTo(this.size/2, -this.size, -this.size, -this.size*0.8, -this.size, 0);
        // Bottom curve
        fishingCtx.bezierCurveTo(-this.size, this.size*0.8, this.size/2, this.size, this.size, isBiting ? 8 : 0);
        fishingCtx.fill();

        // 4. Scales / Stripes (Decoration)
        fishingCtx.strokeStyle = 'rgba(0,0,0,0.1)';
        fishingCtx.lineWidth = 2;
        fishingCtx.beginPath();
        fishingCtx.arc(-10, 0, this.size/2, -Math.PI/2, Math.PI/2);
        fishingCtx.stroke();
        fishingCtx.beginPath();
        fishingCtx.arc(5, 0, this.size/2, -Math.PI/2, Math.PI/2);
        fishingCtx.stroke();

        // 5. Eye (Big & Cute)
        fishingCtx.fillStyle = 'white';
        fishingCtx.beginPath();
        fishingCtx.arc(this.size * 0.4, -this.size * 0.2, 9, 0, Math.PI * 2);
        fishingCtx.fill();
        fishingCtx.fillStyle = '#222';
        fishingCtx.beginPath();
        fishingCtx.arc(this.size * 0.4 + 3, -this.size * 0.2, 4, 0, Math.PI * 2);
        fishingCtx.fill();
        fishingCtx.fillStyle = 'white';
        fishingCtx.beginPath();
        fishingCtx.arc(this.size * 0.4 + 5, -this.size * 0.2 - 2, 2, 0, Math.PI * 2);
        fishingCtx.fill();
      }
      fishingCtx.restore();

      // Name Text
      const hideCheckbox = document.getElementById('hideFishNamesCheckbox');
      if (!hideCheckbox || !hideCheckbox.checked) {
        const fontSize = Math.max(12, fishingCanvas.width / 60); // Dynamic font size for fish
        
        if (this.cachedFontSize !== fontSize) {
            fishingCtx.font = `bold ${fontSize}px "Khmer OS Battambang"`;
            this.textWidth = fishingCtx.measureText(this.name).width;
            this.cachedFontSize = fontSize;
        }
        fishingCtx.font = `bold ${fontSize}px "Khmer OS Battambang"`;
        const textWidth = this.textWidth;
        
        // Text Background Pill
        fishingCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        fishingCtx.beginPath();
        if (fishingCtx.roundRect) fishingCtx.roundRect(this.x - textWidth/2 - 8, this.y + 32, textWidth + 16, 24, 12);
        else fishingCtx.rect(this.x - textWidth/2 - 8, this.y + 32, textWidth + 16, 24);
        fishingCtx.fill();

        fishingCtx.fillStyle = 'white';
        fishingCtx.textAlign = 'center';
        // Shadow (Optimized)
        fishingCtx.fillStyle = 'rgba(0,0,0,0.8)';
        fishingCtx.fillText(this.name, this.x + 2, this.y + 51);
        // Text
        fishingCtx.fillStyle = 'white';
        fishingCtx.fillText(this.name, this.x, this.y + 49);
      }
    }
  }

  function initFish() {
    // Shuffle vertical positions (ច្របល់ទីតាំងកម្ពស់ ដើម្បីកុំឱ្យត្រីនៅផ្តុំគ្នា)
    const indices = Array.from({ length: fishingNames.length }, (_, i) => i);
    for (let i = indices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
    }
    fishes = fishingNames.map((n, i) => new Fish(n, indices[i], fishingNames.length));

    // Fix: Reset hook if fish are re-initialized to avoid chasing ghost fish
    if (hook.state !== 'idle') {
        hook.state = 'idle';
        hook.target = null;
        hook.y = -50;
        hook.x = fishingCanvas.width / 2;
    }
  }

  function drawGame() {
    if (!isFishingActive) return;
    fishingCtx.clearRect(0, 0, fishingCanvas.width, fishingCanvas.height);

    // Calculate swing angle
    let swingAngle = 0;
    if (hook.state === 'idle') {
        const time = Date.now() * 0.003;
        swingAngle = Math.sin(time) * 0.5;
    }

    // Draw Bubbles
    if (Math.random() < 0.15) bubbles.push(new Bubble());
    bubbles.forEach((b, i) => {
      b.update();
      b.draw();
      if (b.y < -10) bubbles.splice(i, 1);
    });

    // Draw Splashes
    for (let i = splashes.length - 1; i >= 0; i--) {
      let s = splashes[i];
      s.update();
      s.draw();
      if (s.life <= 0) splashes.splice(i, 1);
    }

    // Draw Fire Particles
    for (let i = fireParticles.length - 1; i >= 0; i--) {
      let p = fireParticles[i];
      p.update();
      p.draw();
      if (p.life <= 0) fireParticles.splice(i, 1);
    }

    // Draw Fish
    fishes.forEach(fish => {
        if ((hook.state !== 'reeling' && hook.state !== 'biting') || hook.target !== fish) {
            fish.update();
        }
        fish.draw();
    });

    // Draw Hook Line
    fishingCtx.beginPath();
    fishingCtx.moveTo(fishingCanvas.width / 2, 0);
    fishingCtx.lineTo(hook.x, hook.y);
    fishingCtx.strokeStyle = 'white';
    fishingCtx.lineWidth = 2;
    fishingCtx.stroke();

    // Draw Fancy Hook & Bait (រចនានុយ និងផ្លែសន្ទូច - Improved)
    fishingCtx.save();
    fishingCtx.translate(hook.x, hook.y);
    
    // Glow Effect (ពន្លឺជុំវិញនុយ)
    fishingCtx.shadowColor = 'rgba(255, 255, 255, 0.6)';
    fishingCtx.shadowBlur = 15;

    // 1. The Hook (ផ្លែសន្ទូចពណ៌ប្រាក់)
    fishingCtx.beginPath();
    fishingCtx.moveTo(0, 0); // Eye of hook
    fishingCtx.lineTo(0, 25); // Shank (Longer)
    fishingCtx.arc(-10, 25, 10, 0, Math.PI, false); // Bend
    fishingCtx.lineTo(-18, 15); // Point
    fishingCtx.strokeStyle = '#ecf0f1'; // Bright Silver
    fishingCtx.lineWidth = 4;
    fishingCtx.lineCap = 'round';
    fishingCtx.stroke();
    
    // Hook Barb (បន្លាសន្ទូច)
    fishingCtx.beginPath();
    fishingCtx.moveTo(-18, 15);
    fishingCtx.lineTo(-14, 18);
    fishingCtx.strokeStyle = '#ecf0f1';
    fishingCtx.lineWidth = 2;
    fishingCtx.stroke();

    // 2. The Bait (នុយជន្លេនមានចលនា)
    const time = Date.now() * 0.008;
    const wiggle = Math.sin(time) * 3;
    
    fishingCtx.beginPath();
    fishingCtx.moveTo(2, 10);
    fishingCtx.bezierCurveTo(12 + wiggle, 18, -12 - wiggle, 28, -5, 38); // Wiggly shape
    fishingCtx.strokeStyle = '#ff6b6b'; // Neon Red/Pink
    fishingCtx.lineWidth = 7;
    fishingCtx.lineCap = 'round';
    fishingCtx.stroke();
    
    // Bait details (Stripes)
    fishingCtx.strokeStyle = 'rgba(0,0,0,0.3)';
    fishingCtx.lineWidth = 2;
    fishingCtx.beginPath();
    fishingCtx.moveTo(4, 16); fishingCtx.lineTo(6, 16);
    fishingCtx.moveTo(-2, 26); fishingCtx.lineTo(0, 26);
    fishingCtx.stroke();

    // 3. Sinker/Weight (ដុំសំណរ)
    fishingCtx.shadowBlur = 5;
    fishingCtx.fillStyle = '#95a5a6';
    fishingCtx.beginPath();
    fishingCtx.arc(0, -5, 6, 0, Math.PI * 2);
    fishingCtx.fill();
    
    // Shine on Sinker
    fishingCtx.fillStyle = '#fff';
    fishingCtx.beginPath();
    fishingCtx.arc(-2, -7, 2, 0, Math.PI * 2);
    fishingCtx.fill();

    fishingCtx.restore();

    // Logic
    if (hook.state === 'idle') {
        // Hook swinging animation
        const stringLength = 60;
        hook.x = fishingCanvas.width / 2 + Math.sin(swingAngle) * stringLength;
        hook.y = Math.cos(swingAngle) * stringLength;
    } else if (hook.state === 'dropping') {
        hook.y += 5;
        if (hook.y >= hook.targetY) {
            hook.y = hook.targetY;
            hook.state = 'waiting';
            hook.waitStartTime = Date.now();
        }
    } else if (hook.state === 'waiting') {
        // Wait for 5 seconds before biting (ដាក់នុយ ៥ វិនាទី)
        const elapsed = Date.now() - hook.waitStartTime;
        if (elapsed > 5000 && hook.target && Math.abs(hook.x - hook.target.x) < 10) {
            hook.state = 'biting';
            hook.biteStartTime = Date.now();
            hook.target.x = hook.x;
            hook.target.y = hook.y + 20; // Attach to hook

            // Play splash sound
            const splashSound = document.getElementById('splashSound');
            if (splashSound) {
                splashSound.currentTime = 0;
                splashSound.play().catch(() => {});
            }

            // Play tension sound (សំឡេងខ្សែសន្ទូចតឹង)
            const tensionSound = document.getElementById('tensionSound');
            if (tensionSound) {
                tensionSound.currentTime = 0;
                tensionSound.play().catch(() => {});
            }
        }
    } else if (hook.state === 'biting') {
        const elapsed = Date.now() - hook.biteStartTime;
        if (elapsed > 2000) { // ត្រីរើ ២ វិនាទី
            hook.state = 'reeling';
            const tensionSound = document.getElementById('tensionSound');
            if (tensionSound) {
                tensionSound.pause();
            }
        }
        if(hook.target) {
             // Effect ត្រីរើ និងទាញរត់ (Shake & Run)
             const runOffset = Math.sin(elapsed * 0.01) * 50; // ត្រីទាញឆ្វេងស្តាំខ្លាំង
             const shakeX = (Math.random() - 0.5) * 15;
             const shakeY = (Math.random() - 0.5) * 15;
             
             hook.x = (fishingCanvas.width / 2) + runOffset + shakeX;
             hook.y = hook.targetY + Math.abs(Math.sin(elapsed * 0.02) * 20) + shakeY; // ទាញចុះក្រោម

             hook.target.x = hook.x;
             hook.target.y = hook.y + 20;

             // Add extra bubbles when biting
             if (Math.random() < 0.5) {
                 let b = new Bubble();
                 b.x = hook.x + (Math.random() - 0.5) * 40;
                 b.y = hook.y + 20;
                 bubbles.push(b);
             }

             // Effect ទឹកខ្ទាតខ្លាំងៗនៅផ្ទៃខាងលើ (Strong Surface Splash)
             if (Math.random() < 0.8) { // ឱកាសចេញច្រើន
                 splashes.push(new SplashParticle(hook.x, 0));
                 splashes.push(new SplashParticle(hook.x + (Math.random()-0.5)*10, 0));
             }
        }
    } else if (hook.state === 'reeling') {
        hook.y -= 15;
        hook.x += (fishingCanvas.width / 2 - hook.x) * 0.1; // Pull back to center
        if(hook.target) {
             hook.target.x = hook.x;
             hook.target.y = hook.y + 20;
        }
        if (hook.y <= 50) {
            hook.state = 'idle';
            if(hook.target) {
                // Create Fire Effect
                for(let i=0; i<50; i++) {
                  fireParticles.push(new FireParticle(hook.x, hook.y));
                }

            addToFishingHistory(hook.target.name);
                fishingWinner.textContent = "🎉 " + hook.target.name + " 🎉";
                fishingResultOverlay.dataset.winner = hook.target.name;
                fishingResultOverlay.classList.remove('hidden');
                // Play sound if available
                const resultSound = document.getElementById('resultSound');
                const applauseSound = document.getElementById('applauseSound');
                if(resultSound) resultSound.play();
                if(applauseSound) {
                    applauseSound.currentTime = 0;
                    applauseSound.play().catch(() => {});
                }

                // Confetti Effect
                if (typeof confetti === 'function') {
                    confetti({
                        particleCount: 150,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
            }
        }
    }

    animationId = requestAnimationFrame(drawGame);
  }

  startFishingBtn.onclick = () => {
    if (fishes.length === 0) {
        document.getElementById('emptyInputModal').style.display = 'block';
        return;
    }
    if (hook.state !== 'idle') return;

    const randomIndex = Math.floor(Math.random() * fishes.length);
    hook.target = fishes[randomIndex];
    // ដាក់នុយចូលទឹកយ៉ាងហោចណាស់ជម្រៅ 60%
    const minDepth = fishingCanvas.height * 0.6;
    const maxDepth = fishingCanvas.height * 0.85;
    hook.targetY = Math.random() * (maxDepth - minDepth) + minDepth;
    hook.state = 'dropping';

    // Create Splash Effect
    for(let i=0; i<20; i++) {
      splashes.push(new SplashParticle(hook.x, 0));
    }
    // Add multiple ripples (concentric circles)
    splashes.push(new Ripple(hook.x, 0));
    setTimeout(() => splashes.push(new Ripple(hook.x, 0)), 200);
    setTimeout(() => splashes.push(new Ripple(hook.x, 0)), 400);
  };

  // Result Buttons Logic
  addFishingResultBtn.onclick = () => {
    fishingResultOverlay.classList.add('hidden');
  };

  removeFishingResultBtn.onclick = () => {
    const nameToRemove = fishingResultOverlay.dataset.winner;
    const idx = fishingNames.indexOf(nameToRemove);
    if (idx > -1) {
        fishingNames.splice(idx, 1);
        renderFishingTable();
    }
    fishingResultOverlay.classList.add('hidden');
  };

  closeFishingResultBtn.onclick = () => {
    fishingResultOverlay.classList.add('hidden');
  };

  // Start Loop
  resizeCanvas();
  renderFishingTable();
  // drawGame(); // Handled by tab switching logic

  // Initialize Group Section with Sample Data (កំណត់ឈ្មោះគំរូសម្រាប់បែងចែកក្រុម)
  window.addEventListener('load', () => {
    const gInput = document.getElementById('groupNameInput');
    const gCount = document.getElementById('groupCount');
    const gImport = document.getElementById('importGroupNames');
    const gDistribute = document.getElementById('distributeGroups');
    
    if (gInput && gCount && gImport && gDistribute) {
      gInput.value = "ជានិច្ច\nសុនិតា\nចីរកាល";
      gImport.click(); // បញ្ចូលឈ្មោះទៅក្នុងប្រព័ន្ធ
      gInput.value = ""; // លុបឈ្មោះចេញពីប្រអប់បញ្ចូលវិញ (តាមសំណូមពរ)
      gCount.value = 3;
      setTimeout(() => gDistribute.click(), 100); // បង្ហាញលទ្ធផលបែងចែកក្រុម
    }
  });

  // Initialize Group Section 2 with Sample Data
  window.addEventListener('load', () => {
    const gInput2 = document.getElementById('groupNameInput2');
    const gImport2 = document.getElementById('importGroupNames2');
    const gCount2 = document.getElementById('groupCount2');
    const gDistribute2 = document.getElementById('distributeGroups2');

    if (gInput2 && gImport2) {
      gInput2.value = "ជានិច្ច\nសុនិតា\nចីរកាល";
      gImport2.click();
      gInput2.value = "";
      if (gCount2 && gDistribute2) {
        gCount2.value = 2;
        setTimeout(() => gDistribute2.click(), 100);
      }
    }
  });

  // Convert title attributes to custom tooltips (ធ្វើឱ្យ Tooltip ស្អាត)
  document.querySelectorAll('[title]').forEach(el => {
    el.setAttribute('data-tooltip', el.getAttribute('title'));
    el.removeAttribute('title');
  });

  // Observer for Spin Result to play Applause (សម្រាប់លេងសំឡេងទះដៃពេលបង្វិលកង់ត្រូវ)
  const resultPanel = document.getElementById('resultPanel');
  if (resultPanel) {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const isHidden = resultPanel.classList.contains('hidden');
          const wasHidden = mutation.oldValue ? mutation.oldValue.includes('hidden') : true;
          
          if (!isHidden && wasHidden) { // លេងសំឡេងតែពេលផ្ទាំងលទ្ធផលបើកឡើង
             const applauseSound = document.getElementById('applauseSound');
             // Add to Spin History
             const winnerName = document.getElementById('panelResult').innerText;
             addToHistory('spin', winnerName);

             if(applauseSound) {
                 applauseSound.currentTime = 0;
                 applauseSound.play().catch(() => {});
             }
          }
        }
      });
    });
    observer.observe(resultPanel, { attributes: true, attributeFilter: ['class'], attributeOldValue: true });
  }

  // ================= FISHING HISTORY LOGIC =================
  let currentHistoryType = '';

  function addToFishingHistory(name) {
    addToHistory('fishing', name);
  }

  // Generic Add History Function
  function addToHistory(type, info) {
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    let targetArray, storageKey;
    
    if (type === 'spin') { targetArray = spinHistory; storageKey = 'spinHistory'; }
    else if (type === 'group') { targetArray = groupHistory; storageKey = 'groupHistory'; }
    else if (type === 'group2') { targetArray = groupHistory2; storageKey = 'groupHistory2'; }
    else if (type === 'timer') { targetArray = timerHistory; storageKey = 'timerHistory'; }
    else if (type === 'fishing') { targetArray = fishingHistory; storageKey = 'fishingHistory'; }
    
    if (targetArray) {
      targetArray.unshift({ name: info, time });
      if (targetArray.length > 50) targetArray.pop(); // រក្សាទុកបាន ៥០ ទិន្នន័យចុងក្រោយ
      saveHistory(storageKey, targetArray);
    }
  }

  // Generic Show History Function
  function showHistoryModal(type) {
    currentHistoryType = type;
    const list = document.getElementById('historyList');
    const modal = document.getElementById('historyModal');
    const clearBtn = document.getElementById('clearHistoryBtn');
    
    let data = [];
    if (type === 'spin') data = spinHistory;
    else if (type === 'group') data = groupHistory;
    else if (type === 'group2') data = groupHistory2;
    else if (type === 'timer') data = timerHistory;
    else if (type === 'fishing') data = fishingHistory;

    list.innerHTML = '';
    if (data.length === 0) {
      list.innerHTML = `<li style="text-align:center; padding: 20px;">${currentLang === 'kh' ? 'មិនមានប្រវត្តិ' : 'No history'}</li>`;
    } else {
      data.forEach((item, index) => {
        const idx = currentLang === 'kh' ? toKhmer(index + 1) : (index + 1);
        const li = document.createElement('li');
        li.style.borderBottom = '1px solid #eee';
        li.style.padding = '10px 0';
        li.innerHTML = `<strong>${idx}.</strong> ${item.name} <span style="float:right; color:#666;">${item.time}</span>`;
        list.appendChild(li);
      });
    }
    
    if(clearBtn) clearBtn.style.display = 'inline-block';
    modal.style.display = 'block';
  }

  // Clear History Logic
  const clearHistoryBtn = document.getElementById('clearHistoryBtn');
  if (clearHistoryBtn) {
    clearHistoryBtn.onclick = () => {
      if (currentHistoryType === 'spin') { spinHistory = []; saveHistory('spinHistory', []); }
      else if (currentHistoryType === 'group') { groupHistory = []; saveHistory('groupHistory', []); }
      else if (currentHistoryType === 'group2') { groupHistory2 = []; saveHistory('groupHistory2', []); }
      else if (currentHistoryType === 'timer') { timerHistory = []; saveHistory('timerHistory', []); }
      else if (currentHistoryType === 'fishing') { fishingHistory = []; saveHistory('fishingHistory', []); }
      showHistoryModal(currentHistoryType);
    };
  }

  // Export All History Logic
  const exportHistoryBtn = document.getElementById('exportHistoryBtn');
  if (exportHistoryBtn) {
    exportHistoryBtn.onclick = () => {
      const wb = XLSX.utils.book_new();
      
      const createSheetData = (data) => {
        return data.map((item, index) => ({
          [currentLang === 'kh' ? "ល.រ" : "No."]: index + 1,
          [currentLang === 'kh' ? "ព័ត៌មាន" : "Info"]: item.name,
          [currentLang === 'kh' ? "ម៉ោង" : "Time"]: item.time
        }));
      };

      let hasData = false;
      if (spinHistory.length) { XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(createSheetData(spinHistory)), "Spin"); hasData = true; }
      if (groupHistory.length) { XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(createSheetData(groupHistory)), "Group"); hasData = true; }
      if (groupHistory2.length) { XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(createSheetData(groupHistory2)), "Group2"); hasData = true; }
      if (timerHistory.length) { XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(createSheetData(timerHistory)), "Timer"); hasData = true; }
      if (fishingHistory.length) { XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(createSheetData(fishingHistory)), "Fishing"); hasData = true; }

      if (!hasData) {
        alert(currentLang === 'kh' ? "មិនមានទិន្នន័យសម្រាប់ទាញយកទេ" : "No data to export");
        return;
      }

      XLSX.writeFile(wb, "History_Log.xlsx");
    };
  }

  // Button Listeners
  const historyNamesBtn = document.getElementById('historyNames');
  if (historyNamesBtn) historyNamesBtn.onclick = () => showHistoryModal('spin');

  const historyGroupsBtn = document.getElementById('historyGroups');
  if (historyGroupsBtn) historyGroupsBtn.onclick = () => showHistoryModal('group');

  const historyGroupsBtn2 = document.getElementById('historyGroups2');
  if (historyGroupsBtn2) historyGroupsBtn2.onclick = () => showHistoryModal('group2');

  const historyTimerBtn = document.getElementById('historyTimer');
  if (historyTimerBtn) historyTimerBtn.onclick = () => showHistoryModal('timer');

  const historyFishingBtn = document.getElementById('historyFishing');
  if (historyFishingBtn) {
    historyFishingBtn.onclick = () => showHistoryModal('fishing');
  }
  
  // Capture Events for History
  // Group
  const distributeBtn = document.getElementById('distributeGroups');
  if (distributeBtn) {
    distributeBtn.addEventListener('click', () => {
       const count = document.getElementById('groupCount').value;
       const msg = currentLang === 'kh' ? `បានបែងចែកជា ${toKhmer(count)} ក្រុម` : `Distributed into ${count} groups`;
       addToHistory('group', msg);
    });
  }
  const distributeBtn2 = document.getElementById('distributeGroups2');
  if (distributeBtn2) {
    distributeBtn2.addEventListener('click', () => {
       const count = document.getElementById('groupCount2').value;
       const msg = currentLang === 'kh' ? `បានបែងចែកជា ${toKhmer(count)} ក្រុម` : `Distributed into ${count} groups`;
       addToHistory('group2', msg);
    });
  }

  // Timer
  const startTimerBtn = document.getElementById('startTimer');
  if (startTimerBtn) {
    startTimerBtn.addEventListener('click', () => {
       const msg = currentLang === 'kh' ? 'បានចាប់ផ្តើម' : 'Started';
       addToHistory('timer', msg);
    });
  }

  // Restore Clear Button when closing modal
  const closeHistoryBtns = document.querySelectorAll('#historyModal .close-btn, #historyModal button:not(#clearHistoryBtn)');
  closeHistoryBtns.forEach(btn => {
      btn.addEventListener('click', () => {
          const clearBtn = document.getElementById('clearHistoryBtn');
          if(clearBtn) setTimeout(() => clearBtn.style.display = 'inline-block', 300);
      });
  });

  // Observer to force "លុប" instead of "បិទ" in tables (Spin & Group) generated by script.js
  const fixTableButtons = (tbody) => {
    if (!tbody) return;
    const observer = new MutationObserver(() => {
      tbody.querySelectorAll('button').forEach(btn => {
        if (btn.textContent === 'បិទ') {
          btn.textContent = 'លុប';
          btn.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)'; // Red gradient for Delete
          btn.style.color = 'white';
        }
      });
    });
    observer.observe(tbody, { childList: true, subtree: true });
  };
  fixTableButtons(document.querySelector('#namesTable tbody'));
  fixTableButtons(document.querySelector('#groupNamesTable tbody'));
  fixTableButtons(document.querySelector('#groupNamesTable2 tbody'));

  // Add Enter key support for inputs (ចុច Enter ដើម្បីបញ្ចូលឈ្មោះ)
  const addEnterSupport = (inputId, btnId) => {
    const input = document.getElementById(inputId);
    const btn = document.getElementById(btnId);
    if (input && btn) {
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          btn.click();
        }
      });
    }
  };
  addEnterSupport('nameInput', 'importNames');
  addEnterSupport('groupNameInput', 'importGroupNames');
  addEnterSupport('groupNameInput2', 'importGroupNames2');
  addEnterSupport('fishingNameInput', 'importFishingNames');
  addEnterSupport('timerHourInput', 'startTimer');
  addEnterSupport('timerMinuteInput', 'startTimer');
  addEnterSupport('timerSecondInput', 'startTimer');

  // Double Click to Edit Name (ចុចពីរដងដើម្បីកែឈ្មោះ)
  const enableDoubleClickEdit = (tableId, getDataArray, renderCallback) => {
    const table = document.getElementById(tableId);
    if (!table) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    tbody.addEventListener('dblclick', (e) => {
      const cell = e.target.closest('td');
      // Assuming Name is in 2nd column (index 1)
      if (!cell || cell.cellIndex !== 1) return;

      const row = cell.parentElement;
      const rowIndex = Array.from(tbody.children).indexOf(row);
      
      const currentName = cell.innerText;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentName;
      input.style.width = '95%';
      input.style.padding = '10px 20px';
      input.style.fontSize = '1.1rem';
      input.style.fontFamily = 'Khmer OS Battambang';
      input.style.border = '2px solid #00c6ff';
      input.style.borderRadius = '50px';
      input.style.boxSizing = 'border-box';
      input.style.boxShadow = '0 5px 20px rgba(0, 198, 255, 0.4)';
      input.style.textAlign = 'center';
      input.style.outline = 'none';
      input.style.color = '#2c3e50';
      input.style.fontWeight = 'bold';
      input.style.background = '#fff';
      
      cell.innerHTML = '';
      cell.appendChild(input);
      input.focus();

      let isSaved = false;
      const save = () => {
        if (isSaved) return;
        isSaved = true;
        
        const newName = input.value.trim();
        const data = getDataArray();
        
        if (newName && newName !== currentName && data) {
           data[rowIndex] = newName; // Update Array
           
           let targetCell = cell;
           if (renderCallback) {
             renderCallback(); // Re-render if function exists
             // Re-select cell because DOM might be rebuilt
             const newRow = tbody.children[rowIndex];
             if (newRow) targetCell = newRow.children[1];
           } else {
             cell.innerText = newName; // Update DOM directly
           }

           // Highlight Effect (Effect ភ្លើង)
           if (targetCell) {
             targetCell.animate([
               { backgroundColor: 'rgba(255, 235, 59, 0.8)', boxShadow: '0 0 15px rgba(255, 235, 59, 0.8)', transform: 'scale(1.05)' },
               { backgroundColor: 'transparent', boxShadow: 'none', transform: 'scale(1)' }
             ], { duration: 800, easing: 'ease-out' });
           }
        } else {
           cell.innerText = currentName; // Revert
        }
      };

      input.addEventListener('blur', save);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            input.blur();
        }
      });
    });
  };

  // Enable for all tables
  enableDoubleClickEdit('fishingNamesTable', () => fishingNames, renderFishingTable);
  enableDoubleClickEdit('namesTable', () => window.names, () => { if (typeof window.renderNames === 'function') window.renderNames(); });
  enableDoubleClickEdit('groupNamesTable', () => window.groupNames, () => { if (typeof window.renderGroupNames === 'function') window.renderGroupNames(); });
  enableDoubleClickEdit('groupNamesTable2', () => window.groupNames2, () => { if (typeof window.renderGroupNames2 === 'function') window.renderGroupNames2(); });

  // ================= COPY NAMES LOGIC =================
  const setupCopyBtn = (btnId, tableId) => {
    const btn = document.getElementById(btnId);
    if (btn) {
      btn.onclick = () => {
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        const list = Array.from(rows).map(row => row.cells[1].textContent);
        
        if (list.length === 0) {
           document.getElementById('noNamesToCopyModal').style.display = 'block';
           return;
        }
        const text = list.join('\n');
        navigator.clipboard.writeText(text).then(() => {
           const originalText = btn.textContent;
           btn.textContent = currentLang === 'kh' ? "✅ បានចម្លង!" : "✅ Copied!";
           setTimeout(() => { btn.textContent = translations[currentLang].copyNames; }, 2000);
        });
      };
    }
  };
  setupCopyBtn('copyNames', 'namesTable');
  setupCopyBtn('copyGroupNames', 'groupNamesTable');
  setupCopyBtn('copyGroupNames2', 'groupNamesTable2');
  setupCopyBtn('copyFishingNames', 'fishingNamesTable');

  // ================= SAVED LISTS MANAGER LOGIC (កូដគ្រប់គ្រងការរក្សាទុកបញ្ជីឈ្មោះ) =================
  function setupSavedListManager(prefix, inputId, importBtnId) {
    const dropdown = document.getElementById(prefix + 'Dropdown');
    const btnSave = document.getElementById(prefix + 'BtnSave');
    const btnLoad = document.getElementById(prefix + 'BtnLoad');
    const btnRename = document.getElementById(prefix + 'BtnRename');
    const btnDelete = document.getElementById(prefix + 'BtnDelete');
    const input = document.getElementById(inputId);
    const importBtn = document.getElementById(importBtnId);
    const deleteBtnInModal = document.getElementById('deleteListBtnInModal');

    if (!dropdown || !btnSave || !btnLoad || !input) return;

    function loadLists() {
      const lists = JSON.parse(localStorage.getItem('savedClassLists') || '{}');
      const defaultText = currentLang === 'kh' ? "-- ជ្រើសរើសថ្នាក់ដែលបានរក្សាទុក --" : "-- Select Saved Class --";
      dropdown.innerHTML = `<option value="">${defaultText}</option>`;
      Object.keys(lists).forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        dropdown.appendChild(option);
      });
    }

    btnSave.onclick = () => {
      let data = [];
      if (prefix === 'savedLists') data = window.names;
      else if (prefix === 'savedListsGroup') data = window.groupNames;
      else if (prefix === 'savedListsGroup2') data = window.groupNames2;
      else if (prefix === 'savedListsFishing') data = window.fishingNames;

      if (!data || data.length === 0) {
         const val = input.value;
         if(val.trim()) data = val.split(/\r?\n/).map(n=>n.trim()).filter(Boolean);
      }

      if (!data || data.length === 0) {
        document.getElementById('saveEmptyModal').style.display = 'block';
        return;
      }

      // Open Custom Modal instead of prompt
      const modal = document.getElementById('saveListModal');
      const nameInput = document.getElementById('saveListNameInput');
      const confirmBtn = document.getElementById('confirmSaveListBtn');
      
      if(modal && nameInput && confirmBtn) {
          if(deleteBtnInModal) deleteBtnInModal.style.display = 'none';
          // Reset UI for Save
          const title = modal.querySelector('h2');
          const msg = modal.querySelector('p');
          if(title) title.textContent = translations[currentLang].saveListTitle;
          if(msg) msg.textContent = translations[currentLang].saveListMsg;

          nameInput.value = '';
          modal.style.display = 'block';
          nameInput.focus();
          
          const saveAction = () => {
              const listName = nameInput.value.trim();
              if(listName) {
                  const lists = JSON.parse(localStorage.getItem('savedClassLists') || '{}');
                  lists[listName] = data;
                  localStorage.setItem('savedClassLists', JSON.stringify(lists));
                  updateAllDropdowns();
                  dropdown.value = listName;
                  const successModal = document.getElementById('successModal');
                  if(successModal) {
                      document.getElementById('successTitle').textContent = currentLang === 'kh' ? "ជោគជ័យ!" : "Success!";
                      document.getElementById('successMsg').textContent = currentLang === 'kh' ? "បានរក្សាទុកជោគជ័យ!" : "Saved successfully!";
                      successModal.style.display = 'block';
                  }
                  modal.style.display = 'none';
              } else {
                  alert(currentLang === 'kh' ? "សូមបញ្ចូលឈ្មោះថ្នាក់!" : "Please enter a class name!");
                  nameInput.focus();
              }
          };

          confirmBtn.onclick = saveAction;
          nameInput.onkeydown = (e) => {
              if(e.key === 'Enter') saveAction();
          };
      }
    };

    btnLoad.onclick = () => {
      const name = dropdown.value;
      if(!name) return;
      const lists = JSON.parse(localStorage.getItem('savedClassLists') || '{}');
      if(lists[name]) {
         input.value = lists[name].join('\n');
         if(importBtn) importBtn.click();
      }
    };

    if (btnRename) {
      btnRename.onclick = () => {
        const oldName = dropdown.value;
        if (!oldName) return;

        const modal = document.getElementById('saveListModal');
        const title = modal.querySelector('h2');
        const msg = modal.querySelector('p');
        const nameInput = document.getElementById('saveListNameInput');
        const confirmBtn = document.getElementById('confirmSaveListBtn');

        if (modal && nameInput && confirmBtn) {
            // Update UI for Rename
            if(title) title.textContent = translations[currentLang].renameListTitle;
            if(msg) msg.textContent = translations[currentLang].renameListMsg;
            nameInput.value = oldName;
            
            if(deleteBtnInModal) {
                deleteBtnInModal.style.display = 'block';
                deleteBtnInModal.onclick = () => {
                    modal.style.display = 'none';
                    if(btnDelete) btnDelete.click();
                };
            }
            
            modal.style.display = 'block';
            nameInput.focus();

            const renameAction = () => {
                const newName = nameInput.value.trim();
                if (newName && newName !== oldName) {
                    const lists = JSON.parse(localStorage.getItem('savedClassLists') || '{}');
                    if (lists[newName]) {
                         alert(currentLang === 'kh' ? "ឈ្មោះនេះមានរួចហើយ!" : "Name already exists!");
                         return;
                    }
                    lists[newName] = lists[oldName];
                    delete lists[oldName];
                    localStorage.setItem('savedClassLists', JSON.stringify(lists));
                    updateAllDropdowns();
                    dropdown.value = newName; // Select the new name
                    const successModal = document.getElementById('successModal');
                    if(successModal) {
                        document.getElementById('successTitle').textContent = currentLang === 'kh' ? "ជោគជ័យ!" : "Success!";
                        document.getElementById('successMsg').textContent = currentLang === 'kh' ? "ប្តូរឈ្មោះជោគជ័យ!" : "Renamed successfully!";
                        successModal.style.display = 'block';
                    }
                    modal.style.display = 'none';
                } else if (newName === oldName) {
                    modal.style.display = 'none';
                } else {
                    alert(currentLang === 'kh' ? "សូមបញ្ចូលឈ្មោះ!" : "Please enter a name!");
                    nameInput.focus();
                }
            };

            confirmBtn.onclick = renameAction;
            nameInput.onkeydown = (e) => { if(e.key === 'Enter') renameAction(); };
        }
      };
    }

    if (btnDelete) {
      btnDelete.onclick = () => {
        const name = dropdown.value;
        if(!name) return;
        
        const modal = document.getElementById('deleteConfirmModal');
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        
        if(modal && confirmBtn) {
           modal.style.display = 'block';
           // Clone to remove old listeners
           const newBtn = confirmBtn.cloneNode(true);
           confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
           
           newBtn.onclick = () => {
               const lists = JSON.parse(localStorage.getItem('savedClassLists') || '{}');
               delete lists[name];
               localStorage.setItem('savedClassLists', JSON.stringify(lists));
               updateAllDropdowns();
               modal.style.display = 'none';
           };
        }
      };
    }

    // Initial load
    loadLists();
    dropdown.loadLists = loadLists;
  }

  function updateAllDropdowns() {
     ['savedLists', 'savedListsGroup', 'savedListsGroup2', 'savedListsFishing'].forEach(prefix => {
        const dd = document.getElementById(prefix + 'Dropdown');
        if(dd && dd.loadLists) dd.loadLists();
     });
  }

  setupSavedListManager('savedLists', 'nameInput', 'importNames');
  setupSavedListManager('savedListsGroup', 'groupNameInput', 'importGroupNames');
  setupSavedListManager('savedListsGroup2', 'groupNameInput2', 'importGroupNames2');
  setupSavedListManager('savedListsFishing', 'fishingNameInput', 'importFishingNames');

  if(langToggleBtn) {
      langToggleBtn.addEventListener('click', () => setTimeout(updateAllDropdowns, 50));
  }

})(); // End of IIFE
</script>
</body>
</html>
